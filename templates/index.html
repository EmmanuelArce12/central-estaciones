<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding: 20px; max-width: 900px; margin: 0 auto; }
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; }
        h1 { color: #2c3e50; margin: 0; font-size: 1.8rem; }
        
        .header-actions { display: flex; gap: 10px; }
        .btn-back { text-decoration: none; background-color: #6c757d; color: white; padding: 8px 15px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; }
        .btn-conf { text-decoration: none; background-color: #343a40; color: white; padding: 8px 12px; border-radius: 6px; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; }
        
        /* BOT√ìN DE ACCI√ìN (CAMBIANTE) */
        #btnAction { 
            border: none; padding: 8px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; 
            display: flex; align-items: center; gap: 5px; font-size: 0.9rem; transition: 0.2s; color: white;
            min-width: 160px; justify-content: center;
        }
        
        /* ESTADO NORMAL: NARANJA */
        .btn-start { background-color: #e67e22; }
        .btn-start:hover { background-color: #d35400; }
        
        /* ESTADO TRABAJANDO: ROJO */
        .btn-working { background-color: #dc3545; animation: pulse 2s infinite; }
        .btn-working:hover { background-color: #c82333; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }

        /* BARRA PROGRESO */
        #progress-panel { display: none; margin: 20px 0; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .progress-track { background-color: #e9ecef; border-radius: 20px; height: 25px; overflow: hidden; width: 100%; margin-bottom: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #007bff, #00c6ff); width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: bold; }
        .status-detail { color: #555; font-weight: 500; font-size: 0.95rem; text-align: center; }

        .search-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 30px; }
        input.flatpickr-input { width: 100%; padding: 12px; font-size: 1.1rem; border: 1px solid #ccc; border-radius: 6px; text-align: center; background: #fff; cursor: pointer; }
        
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 5px solid #ccc; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card.Ma√±ana { border-top-color: #f1c40f; } .card.Tarde { border-top-color: #e67e22; } .card.Noche { border-top-color: #2c3e50; }
        .card h2 { margin: 0 0 5px 0; font-size: 1.4rem; color: #555; display: flex; justify-content: space-between; }
        .monto-grande { font-size: 2rem; font-weight: bold; color: #27ae60; margin: 15px 0; }
        .info-extra { background: #f8f9fa; padding: 10px; border-radius: 6px; font-size: 0.9rem; color: #666; }
        
        .event-dot { width: 6px; height: 6px; border-radius: 50%; position: absolute; bottom: 2px; left: calc(50% - 3px); }
        .dot-green { background: #28a745; } .dot-yellow { background: #ffc107; } .dot-blue { background: #17a2b8; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-actions">
            <a href="/estacion/panel" class="btn-back">‚¨ÖÔ∏è Panel</a>
            <a href="/estacion/config-vox" class="btn-conf">‚öôÔ∏è</a>
        </div>
        
        <button id="btnAction" class="btn-start" onclick="manejarAccion()">
            üîÑ ACTUALIZAR DATOS
        </button>
    </div>
    
    <h1 style="text-align:center;">Reporte: {{ usuario }}</h1>

    <div id="progress-panel">
        <div class="progress-track"><div id="pBar" class="progress-fill">0%</div></div>
        <div id="pText" class="status-detail">Esperando al agente...</div>
    </div>

    <div class="search-box">
        <label style="font-weight:bold; color:#555;">üìÖ Selecciona Fecha:</label>
        <div class="date-picker-wrapper">
            <input type="text" id="fechaSelector" placeholder="Elige fecha...">
        </div>
        <div style="font-size:0.8rem; display:flex; gap:15px; margin-top:5px;">
            <span style="display:flex; align-items:center;"><span class="event-dot dot-green" style="position:static; margin-right:5px;"></span>Completo</span>
            <span style="display:flex; align-items:center;"><span class="event-dot dot-yellow" style="position:static; margin-right:5px;"></span>Incompleto</span>
        </div>
    </div>

    <div id="dashboard" class="dashboard">
        <div style="grid-column: 1/-1; text-align: center; color:#888; margin-top: 20px;">Cargando...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const formatMoney = (val) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(val);
        const iconos = { "Ma√±ana": "üåÖ", "Tarde": "‚òÄÔ∏è", "Noche": "üåô" };
        let pollInterval = null;
        let calendarData = {};
        let esTrabajando = false; // Estado local del bot√≥n

        window.onload = function() {
            verificarEstadoCarga(); 
            cargarColoresCalendario().then(() => {
                iniciarCalendario();
                cargarResumen(new Date().toISOString().split('T')[0]);
            });
        };

        // --- L√ìGICA DEL BOT√ìN √öNICO ---
        function manejarAccion() {
            if (esTrabajando) {
                // Si est√° trabajando, el bot√≥n es DETENER
                if(!confirm("¬øDeseas DETENER la carga actual?")) return;
                fetch('/api/detener-carga', { method: 'POST' }).then(() => {
                    setEstadoBoton(false);
                    document.getElementById('progress-panel').style.display = 'none';
                    if(pollInterval) clearInterval(pollInterval);
                    Swal.fire('Detenido', 'Carga cancelada.', 'info');
                });
            } else {
                // Si est√° libre, el bot√≥n es ACTUALIZAR
                iniciarSincronizacion();
            }
        }

        function setEstadoBoton(trabajando) {
            esTrabajando = trabajando;
            const btn = document.getElementById('btnAction');
            if (trabajando) {
                btn.className = "btn-working";
                btn.innerHTML = '<i class="fas fa-stop-circle"></i> DETENER CARGA';
            } else {
                btn.className = "btn-start";
                btn.innerHTML = 'üîÑ ACTUALIZAR DATOS';
            }
        }

        async function iniciarSincronizacion() {
            const { value: fechaInicio } = await Swal.fire({
                title: 'üîÑ Iniciar Barrido',
                html: '<p>Buscar turnos faltantes desde:</p>',
                input: 'date',
                inputValue: '2024-11-01',
                showCancelButton: true,
                confirmButtonColor: '#e67e22',
                confirmButtonText: 'Iniciar'
            });

            if (fechaInicio) {
                setEstadoBoton(true); // Cambiar a rojo
                document.getElementById('progress-panel').style.display = 'block';
                actualizarBarra(0, "Contactando Agente...");
                
                fetch('/api/lanzar-orden', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fecha_inicio: fechaInicio })
                })
                .then(r => r.json())
                .then(d => {
                    if(d.status === 'ok') {
                        if(!pollInterval) pollInterval = setInterval(verificarEstadoCarga, 1500);
                    } else {
                        setEstadoBoton(false);
                        Swal.fire('Error', 'No se pudo iniciar', 'error');
                    }
                });
            }
        }

        // EN INDEX.HTML (Reemplaza la funci√≥n verificarEstadoCarga completa)

        function verificarEstadoCarga() {
            fetch('/api/estado-progreso')
                .then(r => r.json())
                .then(d => {
                    // DETECCI√ìN INTELIGENTE DE FIN
                    // Si el porcentaje es 100 O el mensaje dice "Completa", es un √©xito,
                    // sin importar si 'd.activo' es true o false.
                    const esFinExitoso = (d.porcentaje >= 100) || (d.mensaje && d.mensaje.includes("Completa"));

                    if (d.activo && !esFinExitoso) {
                        // Sigue trabajando normalmente
                        setEstadoBoton(true);
                        document.getElementById('progress-panel').style.display = 'block';
                        actualizarBarra(d.porcentaje, d.mensaje);
                        
                        // Nos aseguramos de seguir preguntando
                        if(!pollInterval) pollInterval = setInterval(verificarEstadoCarga, 1000);
                    
                    } else if (esFinExitoso) {
                        // CASO DE √âXITO: Forzamos el 100% visual y recargamos
                        actualizarBarra(100, "‚úÖ Carga Completa");
                        
                        // Frenamos el intervalo para no preguntar m√°s
                        if(pollInterval) clearInterval(pollInterval);
                        pollInterval = null;

                        // Esperamos 1 segundo para que el usuario vea el verde y recargamos
                        setTimeout(() => {
                            setEstadoBoton(false);
                            document.getElementById('progress-panel').style.display = 'none';
                            location.reload(); 
                        }, 1000);
                        
                    } else {
                        // CASO INACTIVO / CANCELADO (Solo aqu√≠ ocultamos)
                        setEstadoBoton(false);
                        document.getElementById('progress-panel').style.display = 'none';
                        if(pollInterval) clearInterval(pollInterval);
                        pollInterval = null;
                    }
                })
                .catch(() => {
                    // Si falla la red, no matamos el intervalo, reintentamos
                    console.log("Error de conexi√≥n, reintentando...");
                });
        }

        function actualizarBarra(pct, msg) {
            const b = document.getElementById('pBar');
            const t = document.getElementById('pText');
            // Validaciones visuales
            if (pct > 100) pct = 99; // Nunca mostrar 100 si no termin√≥
            if (msg.includes("Completa")) pct = 100;
            
            b.style.width = pct + '%';
            b.innerText = pct + '%';
            t.innerText = msg;
        }

        // --- CALENDARIO Y DATOS (Igual que antes) ---
        async function cargarColoresCalendario() {
            try {
                const res = await fetch('/api/estado-calendario');
                const data = await res.json();
                data.forEach(i => calendarData[i.fecha] = i.estado);
            } catch (e) {}
        }
        function iniciarCalendario() {
            flatpickr("#fechaSelector", {
                locale: "es", dateFormat: "Y-m-d", defaultDate: "today",
                onChange: (d, s) => cargarResumen(s),
                onDayCreate: (dObj, dStr, fp, elem) => {
                    const f = elem.dateObj.toISOString().split('T')[0];
                    const st = calendarData[f];
                    if (st) {
                        const dot = document.createElement("span");
                        dot.className = `event-dot dot-${st === 'verde' ? 'green' : (st === 'amarillo' ? 'yellow' : 'blue')}`;
                        elem.appendChild(dot);
                    }
                }
            });
        }
        async function cargarResumen(fecha) {
            const d = document.getElementById('dashboard');
            d.innerHTML = '<p style="text-align:center;width:100%;color:#666;">‚è≥ Cargando...</p>';
            try {
                const res = await fetch(`/api/resumen-dia/${fecha}`);
                const data = await res.json();
                d.innerHTML = '';
                if (data.length === 0) { d.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#777;"><h3>üì≠ D√≠a Vac√≠o</h3></div>'; return; }
                let tot = 0;
                data.forEach(t => {
                    tot += t.monto;
                    const div = document.createElement('div');
                    div.className = `card ${t.turno}`;
                    div.innerHTML = `<h2>${t.turno} <span>${iconos[t.turno]}</span></h2><div>üì† ${t.cantidad_cierres} Cierres</div><div class="monto-grande">${formatMoney(t.monto)}</div><div class="info-extra">üïí ${t.horario_real}</div>`;
                    d.appendChild(div);
                });
                const tdiv = document.createElement('div');
                tdiv.className = 'card'; tdiv.style.borderTopColor='#27ae60';
                tdiv.innerHTML = `<h2>TOTAL D√çA üí∞</h2><div class="monto-grande" style="color:#27ae60">${formatMoney(tot)}</div>`;
                d.appendChild(tdiv);
            } catch(e) { d.innerHTML = '<p style="color:red;text-align:center">Error</p>'; }
        }
    </script>
</body>
</html>