<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding: 20px; max-width: 900px; margin: 0 auto; }
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; }
        h1 { color: #2c3e50; margin: 0; font-size: 1.8rem; }
        
        .header-actions { display: flex; gap: 10px; }
        .btn-back { text-decoration: none; background-color: #6c757d; color: white; padding: 8px 15px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; }
        .btn-conf { text-decoration: none; background-color: #343a40; color: white; padding: 8px 12px; border-radius: 6px; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; }
        
        .btn-sync { background-color: #e67e22; color: white; border: none; padding: 8px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; transition: 0.2s; }
        .btn-sync:hover { background-color: #d35400; }
        .btn-sync:disabled { background-color: #ccc; cursor: not-allowed; }

        /* PANEL PROGRESO */
        #progress-panel { display: none; margin: 20px 0; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .progress-track { background-color: #e9ecef; border-radius: 20px; height: 25px; overflow: hidden; width: 100%; margin-bottom: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #007bff, #00c6ff); width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: bold; }
        .status-detail { color: #555; font-weight: 500; font-size: 0.95rem; }
        .loading-spinner { display: inline-block; animation: spin 1s infinite linear; margin-right: 5px;}
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* CONTENEDOR FECHA */
        .search-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 30px; }
        .date-picker-wrapper { width: 100%; max-width: 300px; }
        input.flatpickr-input { width: 100%; padding: 12px; font-size: 1.1rem; border: 1px solid #ccc; border-radius: 6px; text-align: center; background: #fff; cursor: pointer; }

        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 5px solid #ccc; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card.Ma√±ana { border-top-color: #f1c40f; } .card.Tarde { border-top-color: #e67e22; } .card.Noche { border-top-color: #2c3e50; }
        .card h2 { margin: 0 0 5px 0; font-size: 1.4rem; color: #555; display: flex; justify-content: space-between; }
        .monto-grande { font-size: 2rem; font-weight: bold; color: #27ae60; margin: 15px 0; }
        .info-extra { background: #f8f9fa; padding: 10px; border-radius: 6px; font-size: 0.9rem; color: #666; }

        /* COLORES CALENDARIO */
        .day-complete { background: #d4edda !important; border-color: #c3e6cb !important; } /* Verde */
        .day-partial { background: #fff3cd !important; border-color: #ffeeba !important; } /* Amarillo */
        .day-current { border: 2px solid #007bff !important; } /* Azul (Hoy) */
        
        .flatpickr-day.selected { background: #007bff !important; border-color: #007bff !important; }
        
        /* Puntos indicadores */
        .event-dot {
            width: 6px; height: 6px; border-radius: 50%;
            position: absolute; bottom: 2px; left: calc(50% - 3px);
        }
        .dot-green { background: #28a745; }
        .dot-yellow { background: #ffc107; }
        .dot-blue { background: #17a2b8; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-actions">
            <a href="/estacion/panel" class="btn-back">‚¨ÖÔ∏è Panel</a>
            <a href="/estacion/config-vox" class="btn-conf">‚öôÔ∏è</a>
        </div>
        <button id="btnSync" class="btn-sync" onclick="configurarSincronizacion()">
            üîÑ ACTUALIZAR DATOS
        </button>
    </div>
    
    <h1 style="text-align:center;">Reporte: {{ usuario }}</h1>

    <div id="progress-panel">
        <div class="progress-track"><div id="pBar" class="progress-fill">0%</div></div>
        <div id="pText" class="status-detail">Iniciando...</div>
    </div>

    <div class="search-box">
        <label style="font-weight:bold; color:#555;">üìÖ Selecciona Fecha a Visualizar:</label>
        <div class="date-picker-wrapper">
            <input type="text" id="fechaSelector" placeholder="Elige fecha...">
        </div>
        <div style="font-size:0.8rem; display:flex; gap:15px; margin-top:5px;">
            <span style="display:flex; align-items:center;"><span class="event-dot dot-green" style="position:static; margin-right:5px;"></span>Completo</span>
            <span style="display:flex; align-items:center;"><span class="event-dot dot-yellow" style="position:static; margin-right:5px;"></span>Incompleto</span>
        </div>
    </div>

    <div id="dashboard" class="dashboard">
        <div style="grid-column: 1/-1; text-align: center; color:#888; margin-top: 20px;">
            Cargando datos...
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <script>
        const formatMoney = (val) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(val);
        const iconos = { "Ma√±ana": "üåÖ", "Tarde": "‚òÄÔ∏è", "Noche": "üåô" };
        let pollInterval = null;
        let calendarData = {}; // Cache de colores

        // INICIO
        window.onload = function() {
            cargarColoresCalendario().then(() => {
                iniciarCalendario();
                cargarResumen(new Date().toISOString().split('T')[0]); // Cargar hoy
            });
            verificarEstadoCarga();
        };

        // 1. OBTENER COLORES DESDE API
        async function cargarColoresCalendario() {
            try {
                const res = await fetch('/api/estado-calendario');
                const data = await res.json();
                // Convertir a objeto para acceso r√°pido: {"2025-11-28": "verde", ...}
                data.forEach(item => {
                    calendarData[item.fecha] = item.estado;
                });
            } catch (e) { console.error("Error cargando colores", e); }
        }

        // 2. INICIAR CALENDARIO FLATPICKR
        function iniciarCalendario() {
            flatpickr("#fechaSelector", {
                locale: "es",
                dateFormat: "Y-m-d",
                defaultDate: "today",
                onChange: function(selectedDates, dateStr) {
                    cargarResumen(dateStr);
                },
                onDayCreate: function(dObj, dStr, fp, dayElem) {
                    // Esta funci√≥n se ejecuta por cada d√≠a del calendario
                    const fechaIso = dayElem.dateObj.toISOString().split('T')[0];
                    const estado = calendarData[fechaIso];

                    if (estado) {
                        const dot = document.createElement("span");
                        dot.className = "event-dot";
                        if (estado === "verde") dot.classList.add("dot-green");
                        else if (estado === "amarillo") dot.classList.add("dot-yellow");
                        else if (estado === "azul") dot.classList.add("dot-blue");
                        dayElem.appendChild(dot);
                    }
                }
            });
        }

        // 3. LOGICA BARRIDO CON FECHA PERSONALIZADA
        async function configurarSincronizacion() {
            // Usamos SweetAlert para pedir la fecha de forma elegante
            const { value: fechaInicio } = await Swal.fire({
                title: 'üîÑ Configurar Barrido',
                html: '<p>Selecciona desde qu√© fecha quieres re-escanear los reportes.</p><p style="font-size:0.85rem; color:#666;">(Esto rellenar√° los d√≠as incompletos)</p>',
                input: 'date',
                inputValue: '2024-11-01', // Default Noviembre
                showCancelButton: true,
                confirmButtonColor: '#e67e22',
                confirmButtonText: 'Iniciar Carga',
                cancelButtonText: 'Cancelar'
            });

            if (fechaInicio) {
                iniciarCarga(fechaInicio);
            }
        }

        function iniciarCarga(fechaInicio) {
            mostrarUIProceso(true);
            actualizarBarra(1, `Iniciando desde ${fechaInicio}...`);

            fetch('/api/lanzar-orden', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fecha_inicio: fechaInicio })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'ok') {
                    if(!pollInterval) pollInterval = setInterval(verificarEstadoCarga, 1500);
                } else {
                    mostrarUIProceso(false);
                    Swal.fire('Error', 'No se pudo iniciar la orden', 'error');
                }
            })
            .catch(() => {
                mostrarUIProceso(false);
                Swal.fire('Error', 'Fallo de conexi√≥n', 'error');
            });
        }

        function verificarEstadoCarga() {
            fetch('/api/estado-progreso')
                .then(r => r.json())
                .then(d => {
                    if (d.activo) {
                        mostrarUIProceso(true);
                        actualizarBarra(d.porcentaje, d.mensaje);
                        if(!pollInterval) pollInterval = setInterval(verificarEstadoCarga, 1500);
                    } else if (d.porcentaje === 100) {
                        mostrarUIProceso(true);
                        actualizarBarra(100, "‚úÖ Carga Completa");
                        setTimeout(() => {
                            mostrarUIProceso(false);
                            location.reload(); // Recargar para ver los puntos de colores nuevos
                        }, 2500);
                        detenerPolling();
                    } else {
                        mostrarUIProceso(false);
                        detenerPolling();
                    }
                })
                .catch(() => detenerPolling());
        }

        function mostrarUIProceso(mostrar) {
            const p = document.getElementById('progress-panel');
            const b = document.getElementById('btnSync');
            if(mostrar) {
                p.style.display = 'block';
                b.disabled = true;
                b.innerHTML = '<span class="loading-spinner">‚öôÔ∏è</span> TRABAJANDO...';
            } else {
                p.style.display = 'none';
                b.disabled = false;
                b.innerText = "üîÑ ACTUALIZAR DATOS";
            }
        }

        function actualizarBarra(pct, msg) {
            const b = document.getElementById('pBar');
            const t = document.getElementById('pText');
            let w = parseInt(b.style.width)||0;
            if(pct < w && pct !== 0) pct = w; // No retroceder visualmente
            b.style.width = pct + '%';
            b.innerText = pct + '%';
            t.innerText = msg;
        }

        function detenerPolling() {
            if(pollInterval) { clearInterval(pollInterval); pollInterval=null; }
        }

        // CARGAR TARJETAS (Dashboard)
        async function cargarResumen(fecha) {
            const dash = document.getElementById('dashboard');
            dash.innerHTML = '<p style="text-align:center;width:100%;color:#666;">‚è≥ Cargando...</p>';
            try {
                const res = await fetch(`/api/resumen-dia/${fecha}`);
                const data = await res.json();
                dash.innerHTML = '';
                
                if (data.length === 0) {
                    dash.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#777;"><h3>üì≠ D√≠a Vac√≠o</h3><p>No hay datos registrados.</p></div>';
                    return;
                }
                
                let total = 0;
                data.forEach(t => {
                    total += t.monto;
                    const div = document.createElement('div');
                    div.className = `card ${t.turno}`;
                    div.innerHTML = `<h2>${t.turno} <span>${iconos[t.turno]}</span></h2>
                                     <div>üì† ${t.cantidad_cierres} Cierres</div>
                                     <div class="monto-grande">${formatMoney(t.monto)}</div>
                                     <div class="info-extra">üïí ${t.horario_real}</div>`;
                    dash.appendChild(div);
                });
                
                const tot = document.createElement('div');
                tot.className = 'card'; tot.style.borderTopColor='#27ae60';
                tot.innerHTML = `<h2>TOTAL D√çA üí∞</h2><div class="monto-grande" style="color:#27ae60">${formatMoney(total)}</div>`;
                dash.appendChild(tot);
            } catch (e) { dash.innerHTML = '<p style="color:red;text-align:center">Error de conexi√≥n</p>'; }
        }
    </script>
</body>
</html>