<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding: 20px; max-width: 900px; margin: 0 auto; }
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; }
        h1 { color: #2c3e50; margin: 0; font-size: 1.8rem; }
        
        .header-actions { display: flex; gap: 10px; }
        
        .btn-back { text-decoration: none; background-color: #6c757d; color: white; padding: 8px 15px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; }
        .btn-back:hover { background-color: #5a6268; }
        
        /* BOT√ìN CONFIGURAR (NUEVO AQU√ç) */
        .btn-conf { text-decoration: none; background-color: #343a40; color: white; padding: 8px 12px; border-radius: 6px; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; }
        .btn-conf:hover { background-color: #23272b; }

        /* BOT√ìN ACTUALIZAR */
        .btn-sync { background-color: #e67e22; color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; transition: 0.2s; }
        .btn-sync:hover { background-color: #d35400; }
        .btn-sync:disabled { background-color: #ccc; cursor: wait; }
        .spin { animation: rotation 1s infinite linear; }
        @keyframes rotation { from { transform: rotate(0deg); } to { transform: rotate(359deg); } }

        .search-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; }
        input[type="date"] { padding: 10px; font-size: 1.1rem; border-radius: 6px; border: 1px solid #ccc; }
        button.btn-search { padding: 10px 25px; background: #2980b9; color: white; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; }
        button.btn-search:hover { background: #3498db; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; overflow: hidden; border-top: 5px solid #ccc; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card.Ma√±ana { border-top-color: #f1c40f; }
        .card.Tarde { border-top-color: #e67e22; }
        .card.Noche { border-top-color: #2c3e50; }

        .card h2 { margin-top: 0; margin-bottom: 5px; font-size: 1.4rem; color: #555; display: flex; justify-content: space-between; }
        .card .icono { font-size: 1.5rem; }
        
        .cierres-count { font-size: 0.9rem; color: #888; margin-bottom: 15px; font-weight: 600; }
        .monto-grande { font-size: 2rem; font-weight: bold; color: #27ae60; margin: 15px 0; }
        .info-extra { background: #f8f9fa; padding: 10px; border-radius: 6px; font-size: 0.9rem; color: #666; }
        .etiqueta { font-weight: bold; color: #555; display: block; margin-bottom: 3px; }
        .horario { color: #333; font-family: monospace; font-size: 1rem; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-actions">
            <a href="/estacion/panel" class="btn-back">‚¨ÖÔ∏è Volver</a>
            <a href="/estacion/config-vox" class="btn-conf" title="Configurar Conexi√≥n">‚öôÔ∏è</a>
            
            <button id="btnSync" class="btn-sync" onclick="sincronizarDatos()">
                <span id="iconSync">üîÑ</span> Actualizar Datos
            </button>
        </div>
        <h1>üìä Reporte: {{ usuario }}</h1>
    </div>

    <div class="search-box">
        <input type="date" id="fechaSelector">
        <button class="btn-search" onclick="cargarResumen()">Ver Reporte</button>
    </div>

    <div id="msgSync" style="text-align:center; color:#e67e22; margin-bottom:10px; font-weight:bold; display:none;"></div>

    <div id="dashboard" class="dashboard">
        <div style="grid-column: 1/-1; text-align: center; color:#888; margin-top: 20px;">
            Selecciona una fecha arriba para cargar los datos.
        </div>
    </div>

    <script>
        const formatMoney = (val) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(val);
        const iconos = { "Ma√±ana": "üåÖ", "Tarde": "‚òÄÔ∏è", "Noche": "üåô" };

        async function sincronizarDatos() {
            const btn = document.getElementById('btnSync');
            const icon = document.getElementById('iconSync');
            const msg = document.getElementById('msgSync');

            if(!confirm("¬øSolicitar datos faltantes?\nEsto buscar√° desde el √∫ltimo turno cargado.")) return;

            btn.disabled = true; icon.classList.add('spin');
            msg.style.display = 'block'; msg.innerText = "üì° Contactando Agente...";

            try {
                const res = await fetch('/api/lanzar-orden', { method: 'POST' });
                const data = await res.json();
                
                if(data.status === 'ok') {
                    msg.innerText = "‚úÖ Orden enviada. Los datos llegar√°n en breve.";
                    setTimeout(() => { msg.style.display = 'none'; btn.disabled = false; icon.classList.remove('spin'); cargarResumen(); }, 5000);
                } else { alert("Error"); btn.disabled = false; icon.classList.remove('spin'); }
            } catch (e) { alert("Error de conexi√≥n"); btn.disabled = false; icon.classList.remove('spin'); }
        }

        async function cargarResumen() {
            const fecha = document.getElementById('fechaSelector').value;
            const dashboard = document.getElementById('dashboard');
            if(!fecha) return alert("Selecciona fecha");

            dashboard.innerHTML = '<p style="text-align:center; width:100%; color:#666;">‚è≥ Cargando...</p>';

            try {
                const res = await fetch(`/api/resumen-dia/${fecha}`);
                const datos = await res.json();
                dashboard.innerHTML = ''; 
                
                if (datos.length === 0) {
                    dashboard.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #777;"><h3>üì≠ Sin movimientos</h3><p>No se encontraron datos.</p></div>';
                    return;
                }

                let totalDia = 0;
                datos.forEach(turno => {
                    totalDia += turno.monto;
                    const card = document.createElement('div');
                    card.className = `card ${turno.turno}`;
                    card.innerHTML = `
                        <h2>${turno.turno} <span class="icono">${iconos[turno.turno] || ''}</span></h2>
                        <div class="cierres-count">üì† ${turno.cantidad_cierres} Cierres</div>
                        <div class="monto-grande">${formatMoney(turno.monto)}</div>
                        <div class="info-extra"><span class="etiqueta">Horario:</span><span class="horario">üïí ${turno.horario_real}</span></div>
                    `;
                    dashboard.appendChild(card);
                });

                const cardTotal = document.createElement('div');
                cardTotal.className = 'card'; cardTotal.style.borderTopColor = '#27ae60';
                cardTotal.innerHTML = `<h2>TOTAL D√çA üí∞</h2><div class="monto-grande" style="color:#27ae60">${formatMoney(totalDia)}</div>`;
                dashboard.appendChild(cardTotal);

            } catch (e) { dashboard.innerHTML = '<p style="color:red; text-align:center">Error.</p>'; }
        }
        
        document.getElementById('fechaSelector').valueAsDate = new Date();
    </script>
</body>
</html>