<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding: 20px; max-width: 900px; margin: 0 auto; }
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; }
        h1 { color: #2c3e50; margin: 0; font-size: 1.8rem; }
        
        .header-actions { display: flex; gap: 10px; }
        .btn-back { text-decoration: none; background-color: #6c757d; color: white; padding: 8px 15px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; }
        .btn-conf { text-decoration: none; background-color: #343a40; color: white; padding: 8px 12px; border-radius: 6px; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; }
        
        .btn-sync { background-color: #e67e22; color: white; border: none; padding: 8px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; transition: 0.2s; }
        .btn-sync:hover { background-color: #d35400; }
        .btn-sync:disabled { background-color: #ccc; cursor: not-allowed; }

        /* PANEL PROGRESO */
        #progress-panel { display: none; margin: 20px 0; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
        .progress-track { background-color: #e9ecef; border-radius: 20px; height: 25px; overflow: hidden; width: 100%; margin-bottom: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #007bff, #00c6ff); width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: bold; }
        .status-detail { color: #555; font-weight: 500; font-size: 0.95rem; text-align: center; }
        .loading-spinner { display: inline-block; animation: spin 1s infinite linear; margin-right: 5px;}
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* BOT√ìN DETENER */
        .btn-stop {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            background: #dc3545; color: white; border: none; border-radius: 5px;
            padding: 6px 12px; cursor: pointer; font-size: 0.8rem; font-weight: bold;
            box-shadow: 0 2px 4px rgba(220,53,69,0.3); transition: 0.2s;
        }
        .btn-stop:hover { background: #c82333; }

        /* CONTENEDOR FECHA */
        .search-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 30px; }
        .date-picker-wrapper { width: 100%; max-width: 300px; }
        input.flatpickr-input { width: 100%; padding: 12px; font-size: 1.1rem; border: 1px solid #ccc; border-radius: 6px; text-align: center; background: #fff; cursor: pointer; }

        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 5px solid #ccc; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card.Ma√±ana { border-top-color: #f1c40f; } .card.Tarde { border-top-color: #e67e22; } .card.Noche { border-top-color: #2c3e50; }
        .card h2 { margin: 0 0 5px 0; font-size: 1.4rem; color: #555; display: flex; justify-content: space-between; }
        .monto-grande { font-size: 2rem; font-weight: bold; color: #27ae60; margin: 15px 0; }
        .info-extra { background: #f8f9fa; padding: 10px; border-radius: 6px; font-size: 0.9rem; color: #666; }

        /* COLORES CALENDARIO */
        .day-complete { background: #d4edda !important; border-color: #c3e6cb !important; }
        .day-partial { background: #fff3cd !important; border-color: #ffeeba !important; }
        .event-dot { width: 6px; height: 6px; border-radius: 50%; position: absolute; bottom: 2px; left: calc(50% - 3px); }
        .dot-green { background: #28a745; } .dot-yellow { background: #ffc107; } .dot-blue { background: #17a2b8; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-actions">
            <a href="/estacion/panel" class="btn-back">‚¨ÖÔ∏è Panel</a>
            <a href="/estacion/config-vox" class="btn-conf">‚öôÔ∏è</a>
        </div>
        <button id="btnSync" class="btn-sync" onclick="configurarSincronizacion()">
            üîÑ ACTUALIZAR DATOS
        </button>
    </div>
    
    <h1 style="text-align:center;">Reporte: {{ usuario }}</h1>

    <div id="progress-panel">
        <div class="progress-track"><div id="pBar" class="progress-fill">0%</div></div>
        <div id="pText" class="status-detail">Iniciando...</div>
        <button class="btn-stop" onclick="detenerCarga()">DETENER ‚úñ</button>
    </div>

    <div class="search-box">
        <label style="font-weight:bold; color:#555;">üìÖ Selecciona Fecha:</label>
        <div class="date-picker-wrapper">
            <input type="text" id="fechaSelector" placeholder="Elige fecha...">
        </div>
        <div style="font-size:0.8rem; display:flex; gap:15px; margin-top:5px;">
            <span style="display:flex; align-items:center;"><span class="event-dot dot-green" style="position:static; margin-right:5px;"></span>Completo</span>
            <span style="display:flex; align-items:center;"><span class="event-dot dot-yellow" style="position:static; margin-right:5px;"></span>Incompleto</span>
        </div>
    </div>

    <div id="dashboard" class="dashboard">
        <div style="grid-column: 1/-1; text-align: center; color:#888; margin-top: 20px;">Cargando...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const formatMoney = (val) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(val);
        const iconos = { "Ma√±ana": "üåÖ", "Tarde": "‚òÄÔ∏è", "Noche": "üåô" };
        let pollInterval = null;
        let calendarData = {};

        window.onload = function() {
            verificarEstadoCarga(); // Chequear si hay carga activa al entrar
            cargarColoresCalendario().then(() => {
                iniciarCalendario();
                cargarResumen(new Date().toISOString().split('T')[0]);
            });
        };

        // --- FUNCIONES DE CARGA Y CONTROL ---

        async function configurarSincronizacion() {
            const { value: fechaInicio } = await Swal.fire({
                title: 'üîÑ Actualizar desde...',
                html: '<p>¬øDesde qu√© fecha quieres revisar datos?</p>',
                input: 'date',
                inputValue: '2024-11-01',
                showCancelButton: true,
                confirmButtonColor: '#e67e22',
                confirmButtonText: 'Iniciar Barrido'
            });

            if (fechaInicio) {
                mostrarUIProceso(true);
                actualizarBarra(1, `Contactando agente...`);
                
                fetch('/api/lanzar-orden', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fecha_inicio: fechaInicio })
                })
                .then(r => r.json())
                .then(d => {
                    if(d.status === 'ok') {
                        if(!pollInterval) pollInterval = setInterval(verificarEstadoCarga, 1500);
                    } else {
                        mostrarUIProceso(false);
                        Swal.fire('Error', 'No se pudo iniciar', 'error');
                    }
                });
            }
        }

        function verificarEstadoCarga() {
            fetch('/api/estado-progreso')
                .then(r => r.json())
                .then(d => {
                    if (d.activo) {
                        // Sigue trabajando
                        mostrarUIProceso(true);
                        actualizarBarra(d.porcentaje, d.mensaje);
                        if(!pollInterval) pollInterval = setInterval(verificarEstadoCarga, 1500);
                    } 
                    else if (d.mensaje === "‚úÖ Carga Completa" || d.porcentaje === 100) {
                        // TERMIN√ì
                        mostrarUIProceso(true);
                        actualizarBarra(100, "‚úÖ ¬°Finalizado!");
                        
                        // Esperar 2 segundos para que el usuario vea el 100% y luego cerrar
                        setTimeout(() => {
                            mostrarUIProceso(false); // Ocultar barra
                            location.reload();       // Recargar p√°gina para ver datos nuevos
                        }, 2000);
                        
                        detenerPolling();
                    } 
                    else {
                        // Inactivo (por si entras y no hay nada pasando)
                        mostrarUIProceso(false);
                        detenerPolling();
                    }
                })
                .catch(() => detenerPolling());
        }

        // --- DETENER CARGA MANUALMENTE ---
        function detenerCarga() {
            if(!confirm("¬øDetener la carga actual?")) return;
            
            fetch('/api/detener-carga', { method: 'POST' })
                .then(() => {
                    detenerPolling();
                    mostrarUIProceso(false);
                    Swal.fire('Detenido', 'La carga fue cancelada.', 'info');
                });
        }

        function mostrarUIProceso(mostrar) {
            const p = document.getElementById('progress-panel');
            const b = document.getElementById('btnSync');
            if(mostrar) {
                p.style.display = 'block';
                b.disabled = true;
                b.innerHTML = '<span class="loading-spinner">‚öôÔ∏è</span> TRABAJANDO...';
            } else {
                p.style.display = 'none';
                b.disabled = false;
                b.innerText = "üîÑ ACTUALIZAR DATOS";
            }
        }

        function actualizarBarra(pct, msg) {
            const b = document.getElementById('pBar');
            const t = document.getElementById('pText');
            
            // INTELIGENCIA VISUAL: No pasar del 99% si el server no dice "Completo"
            if (pct >= 100 && msg !== "‚úÖ Carga Completa") pct = 99;
            
            // Suavizado visual: No retroceder la barra
            let w = parseInt(b.style.width)||0;
            if(pct < w && pct !== 0) pct = w; 
            
            b.style.width = pct + '%';
            b.innerText = pct + '%';
            t.innerText = msg;
        }

        function detenerPolling() {
            if(pollInterval) { clearInterval(pollInterval); pollInterval=null; }
        }

        // --- CALENDARIO Y DATOS ---
        async function cargarColoresCalendario() {
            try {
                const res = await fetch('/api/estado-calendario');
                const data = await res.json();
                data.forEach(i => calendarData[i.fecha] = i.estado);
            } catch (e) {}
        }

        function iniciarCalendario() {
            flatpickr("#fechaSelector", {
                locale: "es", dateFormat: "Y-m-d", defaultDate: "today",
                onChange: (d, s) => cargarResumen(s),
                onDayCreate: (dObj, dStr, fp, elem) => {
                    const f = elem.dateObj.toISOString().split('T')[0];
                    const st = calendarData[f];
                    if (st) {
                        const dot = document.createElement("span");
                        dot.className = `event-dot dot-${st === 'verde' ? 'green' : (st === 'amarillo' ? 'yellow' : 'blue')}`;
                        elem.appendChild(dot);
                    }
                }
            });
        }

        async function cargarResumen(fecha) {
            const d = document.getElementById('dashboard');
            d.innerHTML = '<p style="text-align:center;width:100%;color:#666;">‚è≥ Cargando...</p>';
            try {
                const res = await fetch(`/api/resumen-dia/${fecha}`);
                const data = await res.json();
                d.innerHTML = '';
                if (data.length === 0) {
                    d.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#777;"><h3>üì≠ D√≠a Vac√≠o</h3></div>';
                    return;
                }
                let tot = 0;
                data.forEach(t => {
                    tot += t.monto;
                    const div = document.createElement('div');
                    div.className = `card ${t.turno}`;
                    div.innerHTML = `<h2>${t.turno} <span>${iconos[t.turno]}</span></h2><div>üì† ${t.cantidad_cierres} Cierres</div><div class="monto-grande">${formatMoney(t.monto)}</div><div class="info-extra">üïí ${t.horario_real}</div>`;
                    d.appendChild(div);
                });
                const tdiv = document.createElement('div');
                tdiv.className = 'card'; tdiv.style.borderTopColor='#27ae60';
                tdiv.innerHTML = `<h2>TOTAL D√çA üí∞</h2><div class="monto-grande" style="color:#27ae60">${formatMoney(tot)}</div>`;
                d.appendChild(tdiv);
            } catch(e) { d.innerHTML = '<p style="color:red;text-align:center">Error</p>'; }
        }
    </script>
</body>
</html>