<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Tiradas</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f8; padding: 20px; max-width: 1100px; margin: 0 auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { color: #2c3e50; margin: 0; font-size: 1.8rem; }
        .btn-back { text-decoration: none; color: #555; font-weight: bold; border: 1px solid #ccc; padding: 8px 15px; border-radius: 5px; background: white; }

        /* SEM√ÅFORO (ESTADO) */
        .status-badge {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem;
            transition: all 0.3s;
        }
        .st-online { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .st-offline { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .dot-green { background: #28a745; box-shadow: 0 0 5px #28a745; }
        .dot-red { background: #dc3545; }

        /* TARJETAS */
        .control-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-remote { border-left: 5px solid #e67e22; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; transition: 0.2s; }
        .btn-orange { background-color: #e67e22; }
        .btn-orange:hover { background-color: #d35400; }
        .btn-orange:disabled { background-color: #ccc; cursor: not-allowed; }

        /* BARRA DE PROGRESO */
        .progress-bar { height: 6px; width: 100%; background: #eee; margin-top: 15px; border-radius: 3px; overflow: hidden; display: none; }
        .progress-fill { height: 100%; background: #e67e22; width: 0%; transition: width 0.3s; }

        /* LISTA DE TIRADAS */
        .main-container { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .vendedor-header { display: flex; justify-content: space-between; padding: 15px 20px; border-bottom: 1px solid #eee; cursor: pointer; background: white; }
        .vendedor-header:hover { background: #f9f9f9; }
        .vendedor-content { display: none; background: #fafafa; padding: 0; }
        .vendedor-content.active { display: block; }
        
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 12px 20px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        th { color: #888; font-weight: normal; font-size: 0.8rem; text-transform: uppercase; }
        td { color: #555; }
    </style>
</head>
<body>

    <div class="header">
        <a href="/estacion/panel" class="btn-back">‚¨ÖÔ∏è Volver</a>
        <h1>üí∏ Sobres y Tiradas</h1>
    </div>

    <div class="control-bar">
        
        <div class="card card-remote">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <label style="font-weight:bold; color:#555;">üì° Estado del Agente:</label>
                <div id="statusBadge" class="status-badge st-offline">
                    <span class="dot dot-red"></span> OFFLINE
                </div>
            </div>

            <p style="font-size:0.85rem; color:#666; margin: 10px 0;">
                <i class="fa-regular fa-clock"></i> √öltima se√±al: <span id="lastSeen">-</span>
            </p>

            <button id="btnSolicitar" class="btn-orange" onclick="solicitarRemoto()" disabled>
                ‚è≥ Buscando conexi√≥n...
            </button>
            
            <div id="progressBar" class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="msgEstado" style="text-align:center; font-size:0.8rem; color:#e67e22; margin-top:8px; display:none;"></div>
        </div>

        <div class="card" style="border-left: 5px solid #3498db;">
            <label style="font-weight:bold; color:#555;">üìÖ Fecha a visualizar:</label>
            <input type="date" value="{{ fecha }}" onchange="window.location.href='?fecha='+this.value" style="width:100%; padding:10px; margin-top:10px; border:1px solid #ccc; border-radius:5px;">
        </div>

    </div>

    {% if tiradas %}
    <div class="main-container">
        {% for vendedor, items in tiradas | sort(attribute='vendedor') | groupby('vendedor') %}
            {% set total = items | sum(attribute='monto') %}
            <div>
                <div class="vendedor-header" onclick="this.nextElementSibling.classList.toggle('active')">
                    <span style="font-weight:800; color:#2c3e50;">{{ vendedor }}</span>
                    <span style="font-weight:800; color:#27ae60;">$ {{ "{:,.2f}".format(total) }}</span>
                </div>
                <div class="vendedor-content">
                    <table>
                        <tr><th>Hora</th><th>Monto</th><th>Detalle</th></tr>
                        {% for t in items %}
                        <tr>
                            <td>{{ t.hora }}</td>
                            <td style="color:#27ae60; font-weight:bold;">$ {{ "{:,.2f}".format(t.monto) }}</td>
                            <td>{{ t.sector }} - {{ t.turno }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>
        {% endfor %}
        
        <div style="padding:20px; background:#f8f9fa; text-align:right; border-top:2px dashed #ddd;">
            <span style="font-size:0.9rem; color:#666; margin-right:10px;">TOTAL GENERAL:</span>
            <span style="font-size:1.5rem; font-weight:bold; color:#27ae60;">$ {{ "{:,.2f}".format(t_plata) }}</span>
        </div>
    </div>
    {% else %}
    <div style="text-align:center; padding:40px; color:#999; border: 2px dashed #ddd; border-radius:10px;">
        <h3>üì≠ Sin datos hoy</h3>
        <p>Verifica que el Agente est√© ONLINE y presiona "Solicitar Datos".</p>
    </div>
    {% endif %}

    <script>
        let isProcessing = false;

        // 1. CHEQUEO CONSTANTE DE ESTADO (SEM√ÅFORO)
        function checkStatus() {
            if (isProcessing) return; 

            fetch('/api/estado-tiradas')
                .then(r => r.json())
                .then(data => {
                    const badge = document.getElementById('statusBadge');
                    const btn = document.getElementById('btnSolicitar');
                    const last = document.getElementById('lastSeen');

                    last.innerText = data.ultima_vez;

                    if (data.online) {
                        badge.className = 'status-badge st-online';
                        badge.innerHTML = '<span class="dot dot-green"></span> CONECTADO';
                        
                        btn.disabled = false;
                        btn.innerText = "üì• SOLICITAR DATOS AHORA";
                        btn.style.opacity = "1";
                        btn.style.cursor = "pointer";
                    } else {
                        badge.className = 'status-badge st-offline';
                        badge.innerHTML = '<span class="dot dot-red"></span> OFFLINE';
                        
                        btn.disabled = true;
                        btn.innerText = "‚õî Agente Desconectado";
                        btn.style.opacity = "0.6";
                        btn.style.cursor = "not-allowed";
                    }
                })
                .catch(console.error);
        }

        // 2. FUNCI√ìN DE SOLICITUD
        function solicitarRemoto() {
            const btn = document.getElementById('btnSolicitar');
            const bar = document.getElementById('progressBar');
            const fill = document.getElementById('progressFill');
            const msg = document.getElementById('msgEstado');

            isProcessing = true;
            btn.disabled = true;
            btn.innerText = "üì° Enviando orden...";
            bar.style.display = 'block';
            msg.style.display = 'block';
            msg.innerText = "Contactando con la PC...";
            fill.style.width = "10%";

            fetch('/api/lanzar-tiradas', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'ok') {
                        fill.style.width = "40%";
                        msg.innerText = "Orden recibida. Esperando archivos...";
                        waitForCompletion(); // Inicia la espera activa
                    } else {
                        alert("Error al enviar orden");
                        resetUI();
                    }
                })
                .catch(() => {
                    alert("Error de conexi√≥n");
                    resetUI();
                });
        }

        // 3. ESPERA ACTIVA (Polling hasta que termine)
        function waitForCompletion() {
            const fill = document.getElementById('progressFill');
            let progress = 40;
            
            const interval = setInterval(() => {
                // Simulaci√≥n de avance visual
                progress += 5;
                if (progress > 90) progress = 90;
                fill.style.width = progress + "%";

                fetch('/api/estado-tiradas')
                    .then(r => r.json())
                    .then(data => {
                        // Si comando_pendiente es FALSE, significa que el agente ya lo proces√≥
                        if (!data.comando_pendiente) {
                            clearInterval(interval);
                            fill.style.width = "100%";
                            document.getElementById('msgEstado').innerText = "‚úÖ ¬°Datos Recibidos!";
                            document.getElementById('msgEstado').style.color = "green";
                            
                            // Recarga para ver los datos nuevos
                            setTimeout(() => window.location.reload(), 1500);
                        }
                    });
            }, 1000);
            
            // Timeout de seguridad (20 segundos)
            setTimeout(() => {
                clearInterval(interval);
                window.location.reload(); 
            }, 20000);
        }

        function resetUI() {
            isProcessing = false;
            document.getElementById('progressBar').style.display = 'none';
            document.getElementById('msgEstado').style.display = 'none';
            checkStatus();
        }

        setInterval(checkStatus, 3000); // Chequear cada 3 seg
        checkStatus(); // Chequeo inicial
    </script>
</body>
</html>