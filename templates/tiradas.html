<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Tiradas</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f8; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { color: #2c3e50; margin: 0; font-size: 1.8rem; }
        .btn-back { text-decoration: none; color: #555; font-weight: bold; border: 1px solid #ccc; padding: 8px 15px; border-radius: 5px; background: white; transition:0.2s; }
        .btn-back:hover { background: #e9ecef; }

        /* FILTROS */
        .filter-bar { background: #fff; padding: 10px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filter-item { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; font-weight: 600; color: #555; cursor: pointer; }
        input[type="checkbox"] { transform: scale(1.2); cursor: pointer; }

        /* TARJETAS CONTROL */
        .control-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-remote { border-left: 5px solid #e67e22; }
        
        /* --- NUEVO: ESTILOS DEL PANEL DE CARGA --- */
        .load-panel { margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
        .load-row { display: flex; gap: 10px; align-items: center; }
        .date-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; }
        
        button.btn-orange { flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; background-color: #e67e22; transition:0.2s; }
        button.btn-orange:hover { background-color: #d35400; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* SECCIONES POR TURNO */
        .turno-section { margin-bottom: 30px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .turno-header { padding: 12px 20px; color: white; font-size: 1.1rem; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; }
        
        .Ma√±ana .turno-header { background: linear-gradient(to right, #f1c40f, #d4ac0d); }
        .Tarde .turno-header { background: linear-gradient(to right, #e67e22, #d35400); }
        .Noche .turno-header { background: linear-gradient(to right, #2c3e50, #1a252f); }
        .Sin.Asignar .turno-header { background: #95a5a6; }

        /* VENDEDORES (ACORDEON) */
        .vendedor-header { display: flex; justify-content: space-between; padding: 15px 20px; border-bottom: 1px solid #eee; cursor: pointer; background: white; transition: background 0.2s; }
        .vendedor-header:hover { background: #f9f9f9; }
        .vendedor-header.active { background: #f0f4f8; border-left: 4px solid #3498db; }

        /* ESTILO ESPECIAL PARA M√ÅQUINAS */
        .is-machine { background-color: #fff8e1; border-left: 4px solid #f1c40f !important; }
        .is-machine .vh-name { color: #d35400; }

        .vh-name { font-weight: 800; color: #2c3e50; font-size: 1.1rem; }
        .vh-total { font-weight: 800; color: #27ae60; font-size: 1.1rem; }
        .vh-count { font-size: 0.85rem; color: #888; margin-left: 10px; font-weight: normal; }

        .vendedor-content { display: none; background: #fafafa; padding: 0; }
        .vendedor-content.active { display: block; }
        
        /* TABLA DETALLE */
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 10px 20px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        th { color: #888; font-weight: normal; font-size: 0.8rem; text-transform: uppercase; background: #fff; }
        
        /* COLUMNAS OCULTABLES */
        .col-bills, .col-meta { display: none; }
        .show-bills .col-bills { display: table-cell; }
        .show-meta .col-meta { display: table-cell; }

        .bill-tag { background: #e9ecef; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; color: #495057; display: inline-block; margin-right: 4px; margin-bottom: 4px; }
        .bill-val { font-weight: bold; }
        
        /* ESTADO */
        .status-badge { padding: 5px 10px; border-radius: 15px; font-weight: bold; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 5px; }
        .st-online { background:#d4edda; color:#155724; border:1px solid #c3e6cb; } .st-offline { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .dot-green { background:#28a745; } .dot-red { background:#dc3545; }
    </style>
</head>
<body>

    <div class="header">
        <a href="/estacion/panel" class="btn-back">‚¨ÖÔ∏è Volver</a>
        <h1>üí∏ Sobres y Tiradas</h1>
    </div>

    <div class="filter-bar">
        <span>üëÅÔ∏è Visualizaci√≥n:</span>
        <label class="filter-item">
            <input type="checkbox" id="chkBills" onchange="toggleView()"> üíµ Desglose Billetes
        </label>
        <label class="filter-item">
            <input type="checkbox" id="chkMeta" onchange="toggleView()"> üÜî Info T√©cnica
        </label>
    </div>

    <div class="control-bar">
        <!-- TARJETA AGENTE REMOTO (MODIFICADA) -->
        <div class="card card-remote">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <label style="font-weight:bold; color:#555;">üì° Estado Agente:</label>
                <div id="statusBadge" class="status-badge st-offline"><span class="dot dot-red"></span> OFFLINE</div>
            </div>
            <p style="font-size:0.8rem; color:#666; margin: 5px 0;">√öltima se√±al: <span id="lastSeen">-</span></p>
            
            <!-- PANEL DE CARGA CON FECHA -->
            <div class="load-panel">
                <label style="font-size:0.85rem; font-weight:600; color:#555; display:block; margin-bottom:5px;">üì• Traer movimientos desde:</label>
                <div class="load-row">
                    <!-- Input de Fecha -->
                    <input type="date" id="fechaInicioCarga" class="date-input" value="2025-01-01">
                    <!-- Bot√≥n de Acci√≥n -->
                    <button id="btnSolicitar" class="btn-orange" onclick="solicitarRemoto()" disabled>INICIAR CARGA</button>
                </div>
                <div id="msgEstado" style="text-align:center; font-size:0.8rem; color:#e67e22; margin-top:8px; display:none;"></div>
            </div>
        </div>

        <!-- TARJETA FILTRO VISUAL -->
        <div class="card" style="border-left: 5px solid #3498db;">
            <label style="font-weight:bold; color:#555;">üìÖ Viendo fecha:</label>
            <input type="date" value="{{ fecha }}" onchange="window.location.href='?fecha='+this.value" style="width:100%; padding:10px; margin-top:10px; border:1px solid #ccc; border-radius:5px;">
            
            <div style="margin-top:20px; text-align:right;">
                <small style="color:#666;">TOTAL D√çA</small><br>
                <span style="font-size:1.8rem; font-weight:bold; color:#27ae60;">$ {{ "{:,.0f}".format(t_plata) }}</span>
            </div>
        </div>
    </div>

    <div id="mainTable">
        {% set hay_datos = false %}
        
        {% for turno in ['Ma√±ana', 'Tarde', 'Noche', 'Sin Asignar'] %}
            {% if tiradas_por_turno[turno] %}
                {% set hay_datos = true %}
                
                <div class="turno-section {{ turno }}">
                    <div class="turno-header">
                        <span>{{ turno }}</span>
                        <!-- Suma Total Turno -->
                        {% set ns = namespace(total_turno=0) %}
                        {% for vendedor, items in tiradas_por_turno[turno] | groupby('vendedor') %}
                             {% set ns.total_turno = ns.total_turno + (items | sum(attribute='monto')) %}
                        {% endfor %}
                        <span>$ {{ "{:,.0f}".format(ns.total_turno) }}</span>
                    </div>
                    
                    {% for vendedor, items in tiradas_por_turno[turno] | sort(attribute='vendedor') | groupby('vendedor') %}
                        {% set total = items | sum(attribute='monto') %}
                        
                        {% set is_machine = 'buzon' in vendedor.lower() or 'caja' in vendedor.lower() or 'interno' in vendedor.lower() %}
                        
                        <div>
                            <div class="vendedor-header {% if is_machine %}is_machine{% endif %}" onclick="this.nextElementSibling.classList.toggle('active')">
                                <div>
                                    <span class="vh-name">{{ vendedor }}</span>
                                    <span class="vh-count">({{ items|length }} sobres)</span>
                                </div>
                                <span class="vh-total">$ {{ "{:,.2f}".format(total) }}</span>
                            </div>
                            
                            <div class="vendedor-content">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Hora</th>
                                            <th>Nombre CSV</th>
                                            <th class="col-meta">Info Extra</th>
                                            <th class="col-bills">Billetes</th>
                                            <th>Monto</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for t in items %}
                                        <tr>
                                            <td>{{ t.hora }}</td>
                                            <td>{{ t.vendedor_raw }}</td>
                                            
                                            <td class="col-meta" style="font-size:0.8rem; color:#666;">
                                                DNI: {{ t.dni }}<br>ID: {{ t.transaccion }}
                                            </td>
                                            
                                            <td class="col-bills">
                                                {% if t.b2000 > 0 %}<span class="bill-tag">$2000 x <span class="bill-val">{{ t.b2000 }}</span></span>{% endif %}
                                                {% if t.b1000 > 0 %}<span class="bill-tag">$1000 x <span class="bill-val">{{ t.b1000 }}</span></span>{% endif %}
                                                {% if t.b500 > 0 %}<span class="bill-tag">$500 x <span class="bill-val">{{ t.b500 }}</span></span>{% endif %}
                                                {% if t.b200 > 0 %}<span class="bill-tag">$200 x <span class="bill-val">{{ t.b200 }}</span></span>{% endif %}
                                                {% if t.b100 > 0 %}<span class="bill-tag">$100 x <span class="bill-val">{{ t.b100 }}</span></span>{% endif %}
                                                {% if t.cant_billetes > 0 %}<span style="color:#888; font-size:0.75rem;">(Total: {{ t.cant_billetes }})</span>{% endif %}
                                            </td>

                                            <td style="color:#27ae60; font-weight:bold;">$ {{ "{:,.2f}".format(t.monto) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endfor %}

        {% if not hay_datos %}
            <div style="text-align:center; padding:40px; color:#999; border: 2px dashed #ddd; border-radius:10px;">
                <h3>üì≠ Sin datos para esta fecha</h3>
                <p>Verifica la fecha seleccionada o solicita una carga nueva al Agente.</p>
            </div>
        {% endif %}
    </div>

    <script>
        // --- VISTA DIN√ÅMICA ---
        function toggleView() {
            const table = document.getElementById('mainTable');
            const showBills = document.getElementById('chkBills').checked;
            const showMeta = document.getElementById('chkMeta').checked;

            if (showBills) table.classList.add('show-bills'); else table.classList.remove('show-bills');
            if (showMeta) table.classList.add('show-meta'); else table.classList.remove('show-meta');
        }

        // --- CONEXI√ìN Y SOLICITUD ---
        let isProcessing = false;
        
        function checkStatus() {
            if (isProcessing) return;
            
            fetch('/api/estado-tiradas').then(r=>r.json()).then(data => {
                const btn = document.getElementById('btnSolicitar');
                const badge = document.getElementById('statusBadge');
                const msg = document.getElementById('msgEstado');
                document.getElementById('lastSeen').innerText = data.ultima_vez;

                if (data.online) {
                    badge.className = 'status-badge st-online'; 
                    badge.innerHTML = '<span class="dot dot-green"></span> CONECTADO';
                    
                    // Si hay comando pendiente (est√° trabajando), bloqueamos
                    if (data.comando_pendiente) {
                        btn.disabled = true;
                        btn.style.backgroundColor = "#ccc";
                        btn.innerText = "üîÑ PROCESANDO...";
                        msg.style.display = 'block';
                        msg.innerText = "El agente est√° subiendo archivos...";
                        isProcessing = true; // Bloqueamos la interfaz local
                        waitForCompletion(); // Empezamos a vigilar
                    } else {
                        btn.disabled = false;
                        btn.innerText = "INICIAR CARGA";
                        btn.style.backgroundColor = "#e67e22";
                        msg.style.display = 'none';
                    }
                } else {
                    badge.className = 'status-badge st-offline'; 
                    badge.innerHTML = '<span class="dot dot-red"></span> OFFLINE';
                    btn.disabled = true;
                    btn.innerText = "Esperando conexi√≥n...";
                }
            });
        }

        function solicitarRemoto() {
            const fechaInicio = document.getElementById('fechaInicioCarga').value;
            
            if(!confirm(`¬øIniciar carga masiva desde el ${fechaInicio}?\n\nEl agente buscar√° todos los archivos posteriores a esa fecha.`)) return;

            isProcessing = true;
            const btn = document.getElementById('btnSolicitar');
            const msg = document.getElementById('msgEstado');
            
            btn.disabled = true;
            btn.innerText = "üì° ENVIANDO...";
            msg.style.display = 'block';
            msg.innerText = "Contactando agente...";

            // Enviamos fecha al backend
            fetch('/api/lanzar-tiradas', {
                method:'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ fecha_inicio: fechaInicio })
            }).then(r=>r.json()).then(d => {
                if(d.status==='ok') {
                    msg.innerText = "Orden recibida. El agente comenzar√° en breve.";
                    waitForCompletion();
                } else { 
                    alert("Error al enviar orden"); 
                    isProcessing = false; 
                    checkStatus(); 
                }
            });
        }

        function waitForCompletion() {
            const i = setInterval(() => {
                fetch('/api/estado-tiradas').then(r=>r.json()).then(d => {
                    // Si el comando se limpi√≥, significa que el agente termin√≥
                    if (!d.comando_pendiente) {
                        clearInterval(i);
                        document.getElementById('msgEstado').innerText = "‚úÖ ¬°Carga completada!";
                        isProcessing = false;
                        setTimeout(() => window.location.reload(), 2000);
                    }
                });
            }, 3000);
        }

        setInterval(checkStatus, 4000);
        checkStatus();
    </script>
</body>
</html>