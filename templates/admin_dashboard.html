<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Superadmin - Central VOX</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; padding: 20px; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        
        h1 { margin: 0; color: #2c3e50; font-size: 1.5rem; }
        h2 { margin-top: 30px; font-size: 1.2rem; color: #34495e; border-bottom: 2px solid #eee; padding-bottom: 10px; }

        /* ALERTAS */
        .alert { padding: 12px; background-color: #d4edda; color: #155724; border-radius: 6px; margin-bottom: 20px; border-left: 5px solid #28a745; }
        .alert-error { background-color: #f8d7da; color: #721c24; border-left-color: #dc3545; }

        /* GRID DE TARJETAS SUPERIORES */
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px; }
        
        .card { background: #fff; border: 1px solid #e0e0e0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .card h3 { margin-top: 0; font-size: 1rem; display: flex; align-items: center; gap: 10px; }
        
        /* Colores de Tarjetas */
        .card-create { border-top: 4px solid #007bff; }
        .card-vox { border-top: 4px solid #17a2b8; background-color: #fcfdfe; }
        .card-tiradas { border-top: 4px solid #e67e22; background-color: #fffbf7; }

        /* FORMULARIOS */
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .form-group { flex: 1; }
        label { display: block; font-weight: 600; font-size: 0.8rem; margin-bottom: 5px; color: #666; }
        input, select { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.9rem; }
        
        /* BOTONES */
        button { cursor: pointer; padding: 8px 15px; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-primary { background-color: #007bff; color: white; width: 100%; }
        .btn-primary:hover { background-color: #0056b3; }
        
        .btn-vox { background-color: #17a2b8; color: white; }
        .btn-vox:hover { background-color: #138496; }
        
        .btn-tiradas { background-color: #e67e22; color: white; }
        .btn-tiradas:hover { background-color: #d35400; }

        .btn-trash { background-color: #ffebee; color: #c62828; padding: 6px 10px; }
        .btn-trash:hover { background-color: #ffcdd2; }
        .btn-unlink { background-color: #fff3e0; color: #ef6c00; padding: 6px 10px; }

        /* TABLA PRINCIPAL */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        th { text-align: left; padding: 12px; background-color: #f8f9fa; color: #7f8c8d; text-transform: uppercase; font-size: 0.75rem; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background-color: #fafafa; }

        /* COMPONENTES VISUALES */
        .badge { padding: 4px 8px; border-radius: 12px; font-weight: bold; font-size: 0.7rem; display: inline-block; min-width: 60px; text-align: center; }
        .bg-online { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .bg-offline { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .bg-waiting { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

        /* TOKEN WRAPPER CON BOTONES */
        .token-row { display: flex; align-items: center; gap: 5px; margin-top: 5px; }
        
        .token-wrapper { 
            display: flex; align-items: center; border: 1px solid #ced4da; 
            border-radius: 4px; overflow: hidden; max-width: 180px; background: white; flex-grow: 1;
        }
        .token-input { 
            border: none; padding: 4px 8px; font-family: monospace; font-size: 0.8rem; 
            color: #555; width: 100%; outline: none; background: transparent;
        }
        .btn-copy-mini { 
            background: #f1f3f5; color: #495057; border-left: 1px solid #ced4da; 
            padding: 4px 8px; font-size: 0.8rem; cursor: pointer;
        }
        
        /* BOT√ìN BORRAR TOKEN INDIVIDUAL */
        .btn-mini-del {
            background: #ffebee; color: #c62828; border: 1px solid #ffcdd2;
            padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;
        }
        .btn-mini-del:hover { background: #c62828; color: white; }

        .pairing-code { font-size: 1.1rem; font-weight: bold; letter-spacing: 1px; }
        .txt-vox { color: #17a2b8; }
        .txt-tiradas { color: #e67e22; }
        
        .channel-cell { min-width: 240px; }
        .channel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .last-seen { font-size: 0.75rem; color: #999; margin-left: auto; }

        /* Loader */
        #loading-indicator { font-size: 0.8rem; color: #aaa; margin-left: 10px; opacity: 0; transition: opacity 0.3s; }
        
        .btn-trash-station { background-color: #fff; border: 1px solid #dc3545; color: #dc3545; padding: 5px 10px; border-radius: 4px; }
        .btn-trash-station:hover { background-color: #dc3545; color: white; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
        <div style="display:flex; align-items:center;">
            <h1>üõ°Ô∏è Panel Superadmin</h1>
            <span id="loading-indicator"><i class="fa-solid fa-sync fa-spin"></i> Actualizando...</span>
        </div>
        <a href="/logout" style="color:#dc3545; text-decoration:none; font-weight:600;"><i class="fa-solid fa-power-off"></i> Salir</a>
    </div>

    {% if msg %}
        <div class="alert {% if '‚ùå' in msg or 'üö´' in msg %}alert-error{% endif %}">
            {{ msg }}
        </div>
    {% endif %}

    <div class="cards-grid">
        
        <div class="card card-create">
            <h3><i class="fa-solid fa-user-plus"></i> Nueva Estaci√≥n</h3>
            <form method="POST">
                <input type="hidden" name="create_user" value="1">
                <div class="form-row">
                    <div class="form-group"><label>Usuario</label><input type="text" name="username" required></div>
                    <div class="form-group"><label>Clave</label><input type="text" name="password" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Fantas√≠a</label><input type="text" name="nombre"></div>
                    <div class="form-group"><label>Rol</label>
                        <select name="role"><option value="estacion">Estaci√≥n</option><option value="superadmin">Admin</option></select>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="width:100%">Crear</button>
            </form>
        </div>

        <div class="card card-vox">
            <h3 class="txt-vox"><i class="fa-solid fa-gas-pump"></i> Vincular VOX (PC 1)</h3>
            <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">Conexi√≥n para lectura de surtidores.</p>
            <form method="POST" style="display:flex; gap:10px; align-items:flex-end;">
                <input type="hidden" name="link_pc" value="1">
                <div style="flex:1">
                    <label>Estaci√≥n</label>
                    <select name="user_id">
                        {% for u in users %}{% if u.role != 'superadmin' %}<option value="{{ u.id }}">{{ u.username }}</option>{% endif %}{% endfor %}
                    </select>
                </div>
                <div style="width:90px"><label>C√≥digo</label><input type="text" name="pairing_code" placeholder="ABC-12"></div>
                <button type="submit" class="btn-vox">Link</button>
            </form>
        </div>

        <div class="card card-tiradas">
            <h3 class="txt-tiradas"><i class="fa-solid fa-envelope-open-text"></i> Vincular Tiradas (PC 2)</h3>
            <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">Conexi√≥n para subida de sobres/caja.</p>
            <form method="POST" style="display:flex; gap:10px; align-items:flex-end;">
                <input type="hidden" name="link_tiradas" value="1">
                <div style="flex:1">
                    <label>Estaci√≥n</label>
                    <select name="user_id">
                        {% for u in users %}{% if u.role != 'superadmin' %}<option value="{{ u.id }}">{{ u.username }}</option>{% endif %}{% endfor %}
                    </select>
                </div>
                <div style="width:90px"><label>C√≥digo</label><input type="text" name="pairing_code" placeholder="XYZ-99"></div>
                <button type="submit" class="btn-tiradas">Link</button>
            </form>
        </div>

    </div>

    <h2>üì° Estado de Conexiones</h2>
    <table>
        <thead>
            <tr>
                <th style="width:50px;">ID</th>
                <th>Estaci√≥n</th>
                <th>Canal VOX (Surtidores)</th>
                <th>Canal Tiradas (Sobres)</th>
                <th style="width:80px; text-align:center;">Acciones</th>
            </tr>
        </thead>
        <tbody id="table-body">
            {% for u in users %}
            <tr id="row-{{ u.id }}">
                <td>{{ u.id }}</td>
                <td>
                    <strong style="font-size:1rem;">{{ u.username }}</strong><br>
                    <span style="color:#777;">{{ u.cliente_info.nombre_fantasia }}</span>
                </td>
                
                <td class="channel-cell" id="vox-cell-{{ u.id }}">
                    <div class="channel-header">
                        {% if u.status_conexion == 'online' %}<span class="badge bg-online">ONLINE</span>
                        {% elif u.status_conexion == 'waiting' %}<span class="badge bg-waiting">WAITING</span>
                        {% else %}<span class="badge bg-offline">OFFLINE</span>{% endif %}
                        <span class="last-seen">{{ u.last_check.strftime('%H:%M') if u.last_check else '-' }}</span>
                    </div>
                    
                    {% if u.api_token %}
                        <div class="token-row">
                            <div class="token-wrapper" style="border-left: 3px solid #17a2b8;">
                                <input type="text" class="token-input" id="vox-input-{{ u.id }}" value="{{ u.api_token }}" readonly onclick="this.select()">
                                <button class="btn-copy-mini" onclick="copiarInput('vox-input-{{ u.id }}')"><i class="fa-regular fa-copy"></i></button>
                            </div>
                            <form method="POST" onsubmit="return confirm('¬øDesvincular solo VOX?');">
                                <input type="hidden" name="user_id" value="{{ u.id }}">
                                <input type="hidden" name="revoke_vox" value="1">
                                <button type="submit" class="btn-mini-del" title="Desconectar VOX"><i class="fa-solid fa-link-slash"></i></button>
                            </form>
                        </div>
                    {% elif u.device_pairing_code %}
                        <span class="pairing-code txt-vox">{{ u.device_pairing_code }}</span>
                    {% else %}
                        <small style="color:#ccc;">No vinculado</small>
                    {% endif %}
                </td>

                <td class="channel-cell" id="tiradas-cell-{{ u.id }}">
                    <div class="channel-header">
                        {% if u.status_tiradas == 'online' %}<span class="badge bg-online">ONLINE</span>
                        {% elif u.status_tiradas == 'waiting' %}<span class="badge bg-waiting">WAITING</span>
                        {% else %}<span class="badge bg-offline">OFFLINE</span>{% endif %}
                        <span class="last-seen">{{ u.last_check_tiradas.strftime('%H:%M') if u.last_check_tiradas else '-' }}</span>
                    </div>

                    {% if u.token_tiradas %}
                        <div class="token-row">
                            <div class="token-wrapper" style="border-left: 3px solid #e67e22;">
                                <input type="text" class="token-input" id="tiradas-input-{{ u.id }}" value="{{ u.token_tiradas }}" readonly onclick="this.select()">
                                <button class="btn-copy-mini" onclick="copiarInput('tiradas-input-{{ u.id }}')"><i class="fa-regular fa-copy"></i></button>
                            </div>
                            <form method="POST" onsubmit="return confirm('¬øDesvincular solo Tiradas?');">
                                <input type="hidden" name="user_id" value="{{ u.id }}">
                                <input type="hidden" name="revoke_tiradas" value="1">
                                <button type="submit" class="btn-mini-del" title="Desconectar Tiradas"><i class="fa-solid fa-link-slash"></i></button>
                            </form>
                        </div>
                    {% elif u.code_tiradas %}
                        <span class="pairing-code txt-tiradas">{{ u.code_tiradas }}</span>
                    {% else %}
                        <small style="color:#ccc;">No vinculado</small>
                    {% endif %}
                </td>

                <td style="text-align:center;">
                    {% if u.id != current_user.id %}
                    <form action="{{ url_for('eliminar_estacion', id=u.id) }}" method="POST" onsubmit="return confirm('¬øELIMINAR ESTACI√ìN DEFINITIVAMENTE?');">
                        <button type="submit" class="btn-trash-station" title="Eliminar Estaci√≥n"><i class="fa-solid fa-trash"></i></button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    // --- FUNCI√ìN DE COPIAR SEGURA ---
    function copiarInput(inputId) {
        var el = document.getElementById(inputId);
        if(!el) return;
        el.select();
        el.setSelectionRange(0, 99999);
        try {
            document.execCommand('copy');
            // Feedback visual r√°pido
            el.style.backgroundColor = "#d4edda";
            setTimeout(() => el.style.backgroundColor = "transparent", 300);
        } catch (err) {
            alert("Copia manual requerida (Ctrl+C)");
        }
    }

    // --- ACTUALIZACI√ìN DIN√ÅMICA ---
    // IMPORTANTE: Para que esto funcione, la API /admin/api/status-all en app.py 
    // debe devolver los campos: status_tiradas, token_tiradas, code_tiradas, last_check_tiradas
    
    function updateStatus() {
        const ind = document.getElementById('loading-indicator');
        ind.style.opacity = '1';

        fetch('/admin/api/status-all')
            .then(r => r.json())
            .then(data => {
                setTimeout(() => ind.style.opacity = '0', 500);
                
                data.forEach(u => {
                    updateChannel(u.id, 'vox', u.status, u.token, u.code, u.last_check, '#17a2b8', 'txt-vox');
                    // Asumiendo que el JSON trae estos campos nuevos (si no, quedar√° igual)
                    updateChannel(u.id, 'tiradas', u.status_tiradas, u.token_tiradas, u.code_tiradas, u.last_check_tiradas || '-', '#e67e22', 'txt-tiradas');
                });
            })
            .catch(() => ind.style.opacity = '0');
    }

    function updateChannel(uid, prefix, status, token, code, time, color, txtClass) {
        const cell = document.getElementById(`${prefix}-cell-${uid}`);
        if(!cell) return;

        // 1. Badge Status
        let badge = '<span class="badge bg-offline">OFFLINE</span>';
        if(status === 'online') badge = '<span class="badge bg-online">ONLINE</span>';
        if(status === 'waiting') badge = '<span class="badge bg-waiting">WAITING</span>';

        // 2. Content (Token vs Code vs None)
        let content = `<small style="color:#ccc;">No vinculado</small>`;
        
        if (token) {
            // Check if input exists to update value instead of replacing HTML (preserves selection)
            const inputId = `${prefix}-input-${uid}`;
            const existingInput = document.getElementById(inputId);
            
            if(existingInput) {
                if(existingInput.value !== token) existingInput.value = token;
                // Update header only
                const header = cell.querySelector('.channel-header');
                if(header) header.innerHTML = `${badge} <span class="last-seen">${time}</span>`;
                return; 
            }
            
            // Aqu√≠ generamos el HTML con el bot√≥n de borrar espec√≠fico
            // NOTA: Para que el form funcione din√°micamente sin recargar la p√°gina, 
            // necesitar√≠amos JS m√°s complejo, pero para mantenerlo simple y funcional con Jinja/HTML puro:
            // Usamos el mismo HTML que Jinja generar√≠a.
            
            const actionName = prefix === 'vox' ? 'revoke_vox' : 'revoke_tiradas';
            const confirmMsg = prefix === 'vox' ? '¬øDesvincular solo VOX?' : '¬øDesvincular solo Tiradas?';
            const titleMsg = prefix === 'vox' ? 'Desconectar VOX' : 'Desconectar Tiradas';

            content = `
                <div class="token-row">
                    <div class="token-wrapper" style="border-left: 3px solid ${color};">
                        <input type="text" class="token-input" id="${prefix}-input-${uid}" value="${token}" readonly onclick="this.select()">
                        <button class="btn-copy-mini" onclick="copiarInput('${prefix}-input-${uid}')"><i class="fa-regular fa-copy"></i></button>
                    </div>
                    <form method="POST" onsubmit="return confirm('${confirmMsg}');">
                        <input type="hidden" name="user_id" value="${uid}">
                        <input type="hidden" name="${actionName}" value="1">
                        <button type="submit" class="btn-mini-del" title="${titleMsg}"><i class="fa-solid fa-link-slash"></i></button>
                    </form>
                </div>`;
        } else if (code) {
            content = `<span class="pairing-code ${txtClass}">${code}</span>`;
        }

        // Full Render if structure changed
        cell.innerHTML = `
            <div class="channel-header">
                ${badge} <span class="last-seen">${time}</span>
            </div>
            ${content}
        `;
    }

    setInterval(updateStatus, 3000);
</script>

</body>
</html>