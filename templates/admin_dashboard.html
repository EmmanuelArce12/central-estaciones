<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Superadmin - Central VOX</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        
        /* Mensajes */
        .alert { padding: 10px; background-color: #d4edda; color: #155724; border-radius: 4px; margin-bottom: 20px; }
        .alert-error { background-color: #f8d7da; color: #721c24; }

        /* Formularios y Tarjetas */
        .card { background: #fafafa; border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .form-group { margin-bottom: 10px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input, select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        
        /* Botones Generales */
        button { cursor: pointer; padding: 8px 15px; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-warning { background-color: #ffc107; color: #333; }
        
        /* Botones de Icono (Tabla) */
        .btn-icon { padding: 6px 10px; font-size: 1rem; margin: 0 2px; }
        .btn-trash { background-color: #ffebee; color: #c62828; }
        .btn-trash:hover { background-color: #ffcdd2; }
        .btn-unlink { background-color: #fff3e0; color: #ef6c00; }
        .btn-unlink:hover { background-color: #ffe0b2; }

        /* Tabla */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background-color: #f8f9fa; color: #555; text-transform: uppercase; font-size: 0.85rem; }
        
        /* ESTADOS DE CONEXI√ìN */
        .badge { padding: 5px 10px; border-radius: 15px; font-weight: bold; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 6px; }
        .status-online { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .status-offline { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .status-waiting { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

        /* TOKEN BOX (Mismo estilo, pero adaptado para Input) */
        .token-container { 
            display: flex; align-items: center; gap: 5px; 
            background: #f1f3f4; padding: 5px 10px; border-radius: 6px; border: 1px dashed #ccc; 
            max-width: 250px;
        }
        
        /* INPUT TRANSPARENTE PARA EL TOKEN */
        .token-display {
            background: transparent;
            border: none;
            font-family: monospace;
            color: #555;
            font-size: 0.9rem;
            width: 140px; /* Ancho suficiente */
            outline: none;
        }

        .btn-copy { 
            background: none; border: none; color: #007bff; cursor: pointer; font-size: 1.1rem; padding: 0;
        }
        .btn-copy:hover { color: #0056b3; transform: scale(1.1); }

        /* C√ìDIGO GRANDE */
        .pairing-code { font-size: 1.1rem; font-weight: bold; color: #e67e22; letter-spacing: 1px; }

        /* Animaciones */
        .spinner {
            width: 12px; height: 12px; border: 2px solid #856404; border-top: 2px solid transparent;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; }
        .dot-green { background-color: #2e7d32; }
        .dot-red { background-color: #c62828; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>üõ°Ô∏è Panel Superadmin</h1>
        <a href="/logout" style="color:#c62828; font-weight:bold; text-decoration:none;"><i class="fa-solid fa-sign-out-alt"></i> Cerrar Sesi√≥n</a>
    </div>

    {% if msg %}
        <div class="alert {% if '‚ùå' in msg %}alert-error{% endif %}">
            {{ msg }}
        </div>
    {% endif %}

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="card">
            <h3 style="margin-top:0"><i class="fa-solid fa-user-plus"></i> Nueva Estaci√≥n</h3>
            <form method="POST">
                <input type="hidden" name="create_user" value="1">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group"><label>Usuario:</label><input type="text" name="username" required></div>
                    <div class="form-group"><label>Clave:</label><input type="text" name="password" required></div>
                    <div class="form-group"><label>Nombre Fantas√≠a:</label><input type="text" name="nombre"></div>
                    <div class="form-group"><label>Rol:</label>
                        <select name="role">
                            <option value="estacion">Estaci√≥n</option>
                            <option value="superadmin">Administrador</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="width:100%"><i class="fa-solid fa-save"></i> Crear Usuario</button>
            </form>
        </div>

        <div class="card">
            <h3 style="margin-top:0"><i class="fa-solid fa-link"></i> Vinculaci√≥n Manual</h3>
            <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">√ösalo si el c√≥digo autom√°tico falla.</p>
            <form method="POST" style="display:flex; gap:10px; align-items:flex-end;">
                <input type="hidden" name="link_pc" value="1">
                <div style="flex-grow:1">
                    <label>Estaci√≥n:</label>
                    <select name="user_id">
                        {% for u in users %}
                            {% if u.role != 'superadmin' %}
                                <option value="{{ u.id }}">{{ u.username }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div style="width:120px">
                    <label>C√≥digo:</label>
                    <input type="text" name="pairing_code" placeholder="AAA-00">
                </div>
                <button type="submit" class="btn-warning"><i class="fa-solid fa-bolt"></i> Forzar</button>
            </form>
        </div>
    </div>

    <h2 style="margin-top:30px;">
        üì° Estado de Estaciones 
        <span id="loading-indicator" style="font-size:0.5em; color:#bbb; font-weight:normal; opacity:0; transition:opacity 0.5s;">
            <i class="fa-solid fa-sync fa-spin"></i> Actualizando...
        </span>
    </h2>
    
    <table>
        <thead>
            <tr>
                <th style="width: 50px;">ID</th>
                <th>Estaci√≥n / Cliente</th>
                <th>Estado Conexi√≥n</th>
                <th>Vinculaci√≥n / Token</th> 
                <th>√öltima Se√±al</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="users-table-body">
            {% for u in users %}
            <tr id="row-{{ u.id }}">
                <td>{{ u.id }}</td>
                <td>
                    <div style="font-weight:bold; font-size:1rem;">{{ u.username }}</div>
                    <div style="font-size:0.85rem; color:#777;">
                        <i class="fa-solid fa-store"></i> {{ u.cliente_info.nombre_fantasia if u.cliente_info else u.role }}
                    </div>
                </td>
                
                <td id="status-cell-{{ u.id }}">
                    {% if u.status_conexion == 'online' %}
                        <span class="badge status-online"><span class="dot dot-green"></span> ONLINE</span>
                    {% elif u.status_conexion == 'waiting' %}
                        <span class="badge status-waiting"><div class="spinner"></div> ESPERANDO</span>
                    {% else %}
                        <span class="badge status-offline"><span class="dot dot-red"></span> OFFLINE</span>
                    {% endif %}
                </td>

                <td id="auth-cell-{{ u.id }}">
                    {% if u.api_token %}
                        <div class="token-container">
                            <i class="fa-solid fa-key" style="font-size:0.8rem; color:#aaa;"></i>
                            
                            <input type="text" class="token-display" id="token-input-{{ u.id }}" 
                                   value="{{ u.api_token }}" readonly onclick="this.select()">

                            <button class="btn-copy" onclick="copiarToken('token-input-{{ u.id }}')" title="Copiar Token">
                                <i class="fa-regular fa-copy"></i>
                            </button>
                        </div>
                    {% elif u.device_pairing_code %}
                        <span class="pairing-code">{{ u.device_pairing_code }}</span>
                    {% else %}
                        <span style="color:#ccc; font-style:italic;">Sin vincular</span>
                    {% endif %}
                </td>

                <td id="time-cell-{{ u.id }}" style="font-size:0.9rem;">
                    {{ u.last_check.strftime('%d/%m %H:%M') if u.last_check else '-' }}
                </td>

                <td>
                    <div style="display:flex;">
                        <form method="POST" style="display:inline;">
                            <input type="hidden" name="user_id" value="{{ u.id }}">
                            <input type="hidden" name="revoke" value="1">
                            <button type="submit" class="btn-icon btn-unlink" title="Desvincular PC">
                                <i class="fa-solid fa-plug-circle-xmark"></i>
                            </button>
                        </form>
                        {% if u.id != current_user.id %}
                        <form action="{{ url_for('eliminar_estacion', id=u.id) }}" method="POST" onsubmit="return confirm('¬øEliminar esta estaci√≥n y todos sus datos?');" style="display:inline;">
                            <button type="submit" class="btn-icon btn-trash" title="Eliminar Estaci√≥n">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    // --- FUNCI√ìN DE COPIAR SEGURA (Usa el Input Visible) ---
    function copiarToken(inputId) {
        var inputElement = document.getElementById(inputId);
        if (!inputElement) return;

        // 1. Seleccionar el texto visualmente
        inputElement.select();
        inputElement.setSelectionRange(0, 99999); // Para m√≥viles

        // 2. Ejecutar comando de copia (Funciona siempre si hay input seleccionado)
        try {
            var successful = document.execCommand('copy');
            if (successful) {
                alert("‚úÖ Token copiado: " + inputElement.value.substring(0, 8) + "...");
            } else {
                alert("‚ö†Ô∏è No se pudo copiar autom. Presiona Ctrl+C ahora que est√° seleccionado.");
            }
        } catch (err) {
            console.error(err);
            alert("‚ö†Ô∏è Error. Copia el texto manualmente.");
        }
    }

    // Polling para actualizar tabla sin recargar
    function updateStatus() {
        fetch('/admin/api/status-all')
            .then(response => response.json())
            .then(data => {
                const indicator = document.getElementById('loading-indicator');
                indicator.style.opacity = '1';
                setTimeout(() => indicator.style.opacity = '0', 800);

                data.forEach(user => {
                    const statusCell = document.getElementById(`status-cell-${user.id}`);
                    const authCell = document.getElementById(`auth-cell-${user.id}`); 
                    const timeCell = document.getElementById(`time-cell-${user.id}`);
                    
                    if (statusCell && authCell) {
                        timeCell.innerText = user.last_check;

                        // Actualizar Estado
                        let htmlStatus = '';
                        if (user.status === 'online') {
                            htmlStatus = `<span class="badge status-online"><span class="dot dot-green"></span> ONLINE</span>`;
                        } else if (user.status === 'waiting') {
                            htmlStatus = `<span class="badge status-waiting"><div class="spinner"></div> ESPERANDO</span>`;
                        } else {
                            htmlStatus = `<span class="badge status-offline"><span class="dot dot-red"></span> OFFLINE</span>`;
                        }
                        if (statusCell.innerHTML.trim() !== htmlStatus.trim()) statusCell.innerHTML = htmlStatus;

                        // Actualizar Token (SI EL INPUT EXISTE, SOLO CAMBIAMOS EL VALOR)
                        if (user.token) {
                            const inputExistente = document.getElementById(`token-input-${user.id}`);
                            if (inputExistente) {
                                // Si ya existe, solo actualizamos valor si cambi√≥, no redibujamos todo
                                if (inputExistente.value !== user.token) {
                                    inputExistente.value = user.token;
                                }
                            } else {
                                // Si no existe (reci√©n vinculado), dibujamos la cajita
                                authCell.innerHTML = `
                                    <div class="token-container">
                                        <i class="fa-solid fa-key" style="font-size:0.8rem; color:#aaa;"></i>
                                        <input type="text" class="token-display" id="token-input-${user.id}" 
                                            value="${user.token}" readonly onclick="this.select()">
                                        <button class="btn-copy" onclick="copiarToken('token-input-${user.id}')" title="Copiar Token">
                                            <i class="fa-regular fa-copy"></i>
                                        </button>
                                    </div>`;
                            }
                        } else if (user.code) {
                            authCell.innerHTML = `<span class="pairing-code">${user.code}</span>`;
                        } else {
                            authCell.innerHTML = `<span style="color:#ccc; font-style:italic;">Sin vincular</span>`;
                        }
                    }
                });
            })
            .catch(err => console.error("Error polling:", err));
    }

    setInterval(updateStatus, 3000);
</script>

</body>
</html>