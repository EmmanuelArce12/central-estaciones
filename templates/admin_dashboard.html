<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Superadmin - Central VOX</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; padding: 20px; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        
        h1 { margin: 0; color: #2c3e50; font-size: 1.5rem; }
        h2 { margin-top: 30px; font-size: 1.2rem; color: #34495e; border-bottom: 2px solid #eee; padding-bottom: 10px; }

        /* ALERTAS */
        .alert { padding: 12px; background-color: #d4edda; color: #155724; border-radius: 6px; margin-bottom: 20px; border-left: 5px solid #28a745; }
        .alert-error { background-color: #f8d7da; color: #721c24; border-left-color: #dc3545; }

        /* GRID DE TARJETAS (NUEVO ORDEN) */
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 30px; }
        
        .card { background: #fff; border: 1px solid #e0e0e0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); display: flex; flex-direction: column; }
        .card h3 { margin-top: 0; font-size: 1rem; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .card form { margin-top: auto; }

        /* Colores de Tarjetas por Pasos */
        .card-step-1 { border-top: 4px solid #007bff; } /* Azul */
        .card-step-2 { border-top: 4px solid #28a745; } /* Verde */
        .card-step-3 { border-top: 4px solid #6c757d; background-color: #f8f9fa; } /* Gris */

        /* FORMULARIOS */
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .form-group { flex: 1; }
        label { display: block; font-weight: 600; font-size: 0.8rem; margin-bottom: 5px; color: #666; }
        input, select { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.9rem; }
        
        /* BOTONES */
        button { cursor: pointer; padding: 8px 15px; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-primary { background-color: #007bff; color: white; width: 100%; }
        .btn-primary:hover { background-color: #0056b3; }
        
        .btn-success { background-color: #28a745; color: white; width: 100%; }
        .btn-success:hover { background-color: #218838; }

        .btn-link-action { background-color: #6c757d; color: white; }
        .btn-link-action:hover { background-color: #5a6268; }
        
        .btn-trash-station { background-color: #fff; border: 1px solid #dc3545; color: #dc3545; padding: 5px 10px; border-radius: 4px; }
        .btn-trash-station:hover { background-color: #dc3545; color: white; }

        /* TABLA PRINCIPAL */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        th { text-align: left; padding: 12px; background-color: #f8f9fa; color: #7f8c8d; text-transform: uppercase; font-size: 0.75rem; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background-color: #fafafa; }

        /* COMPONENTES VISUALES */
        .badge { padding: 4px 8px; border-radius: 12px; font-weight: bold; font-size: 0.7rem; display: inline-block; min-width: 60px; text-align: center; }
        .bg-online { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .bg-offline { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .bg-waiting { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

        /* TOKEN WRAPPER */
        .token-row { display: flex; align-items: center; gap: 5px; margin-top: 5px; }
        .token-wrapper { display: flex; align-items: center; border: 1px solid #ced4da; border-radius: 4px; overflow: hidden; max-width: 180px; background: white; flex-grow: 1; }
        .token-input { border: none; padding: 4px 8px; font-family: monospace; font-size: 0.8rem; color: #555; width: 100%; outline: none; background: transparent; }
        .btn-copy-mini { background: #f1f3f5; color: #495057; border-left: 1px solid #ced4da; padding: 4px 8px; font-size: 0.8rem; cursor: pointer; }
        
        .btn-mini-del { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .btn-mini-del:hover { background: #c62828; color: white; }

        .pairing-code { font-size: 1.1rem; font-weight: bold; letter-spacing: 1px; }
        .channel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .last-seen { font-size: 0.75rem; color: #999; margin-left: auto; }
        
        /* Loader */
        #loading-indicator { font-size: 0.8rem; color: #aaa; margin-left: 10px; opacity: 0; transition: opacity 0.3s; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
        <div style="display:flex; align-items:center;">
            <h1>üõ°Ô∏è Panel Superadmin</h1>
            <span id="loading-indicator"><i class="fa-solid fa-sync fa-spin"></i> Actualizando...</span>
        </div>
        <a href="/logout" style="color:#dc3545; text-decoration:none; font-weight:600;"><i class="fa-solid fa-power-off"></i> Salir</a>
    </div>

    {% if msg %}
        <div class="alert {% if '‚ùå' in msg or 'üö´' in msg %}alert-error{% endif %}">
            {{ msg }}
        </div>
    {% endif %}

    <div class="cards-grid">
        
        <div class="card card-step-1">
            <h3><i class="fa-solid fa-user-plus"></i> 1. Nueva Estaci√≥n</h3>
            <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">Crea el usuario. No agrega canales autom√°ticamente.</p>
            <form method="POST">
                <input type="hidden" name="create_user" value="1">
                <div class="form-row">
                    <div class="form-group"><label>Usuario</label><input type="text" name="username" required></div>
                    <div class="form-group"><label>Clave</label><input type="text" name="password" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Fantas√≠a</label><input type="text" name="nombre" required></div>
                    <div class="form-group"><label>Rol</label>
                        <select name="role"><option value="estacion">Estaci√≥n</option><option value="superadmin">Admin</option></select>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="width:100%">Crear Estaci√≥n</button>
            </form>
        </div>

        <div class="card card-step-2">
            <h3><i class="fa-solid fa-plus-circle"></i> 2. Agregar Canal</h3>
            <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">Agrega canales (VOX o TIRADAS) a una estaci√≥n existente.</p>
            <form method="POST">
                <input type="hidden" name="add_channel" value="1">
                <div class="form-row">
                    <div class="form-group">
                        <label>Estaci√≥n</label>
                        <select name="user_id" required>
                            <option value="" disabled selected>Seleccionar...</option>
                            {% for u in users %}{% if u.role != 'superadmin' %}<option value="{{ u.id }}">{{ u.username }}</option>{% endif %}{% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo</label>
                        <select name="tipo" required>
                            <option value="VOX">VOX</option>
                            <option value="TIRADAS">TIRADAS</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Nombre (Ej: Caja 1)</label><input type="text" name="nombre" required placeholder="Nombre descriptivo"></div>
                </div>
                <button type="submit" class="btn-success" style="width:100%">Agregar Canal</button>
            </form>
        </div>

        <div class="card card-step-3">
            <h3><i class="fa-solid fa-link"></i> 3. Vincular con Agente</h3>
            <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">Usa el c√≥digo que muestra el programa (Ej: ABC-12).</p>
            <form method="POST">
                <input type="hidden" name="link_channel" value="1">
                <label>Canal disponible</label>
                <select name="channel_id" required>
                    <option value="" disabled selected>Seleccionar canal...</option>
                    {% for u in users %}
                        {% if u.role != 'superadmin' %}
                            <optgroup label="{{ u.username }}">
                                {% for ch in u.channels %}
                                    {% if not ch.token %}
                                        <option value="{{ ch.id }}">{{ ch.tipo }} - {{ ch.nombre }}</option>
                                    {% endif %}
                                {% endfor %}
                            </optgroup>
                        {% endif %}
                    {% endfor %}
                </select>
                <div class="form-row" style="margin-top:10px;">
                    <div class="form-group" style="flex:2;">
                        <input type="text" name="pairing_code" placeholder="C√ìDIGO" required>
                    </div>
                    <button type="submit" class="btn-link-action" style="flex:1;">Vincular</button>
                </div>
            </form>
        </div>

    </div>

    <div style="margin-bottom: 20px; display:flex; justify-content: flex-end;">
        <form method="POST" onsubmit="return confirm('‚ö†Ô∏è ¬øEST√ÅS SEGURO?\n\nEsto borrar√° TODO el historial de tiradas/sobres de la base de datos.\nNo se puede deshacer.');">
            <input type="hidden" name="clean_database" value="1">
            <button type="submit" style="background-color: #dc3545; color: white; padding: 8px 15px; font-size:0.85rem; border-radius: 4px;">
                <i class="fa-solid fa-triangle-exclamation"></i> Vaciar Tabla Tiradas
            </button>
        </form>
    </div>

    <h2>üì° Estado de Conexiones</h2>
    <table>
        <thead>
            <tr>
                <th style="width:50px;">ID</th>
                <th>Estaci√≥n</th>
                <th>Canal VOX (Surtidores)</th>
                <th>Canal Tiradas (Sobres)</th>
                <th style="width:80px; text-align:center;">Acciones</th>
            </tr>
        </thead>
        <tbody id="table-body">
            {% for u in users %}
            {% if u.role != 'superadmin' %}
            <tr id="row-{{ u.id }}">
                <td>{{ u.id }}</td>
                <td>
                    <strong style="font-size:1rem;">{{ u.username }}</strong><br>
                    <span style="color:#777;">{{ u.cliente_info.nombre_fantasia }}</span>
                </td>
                
                {% set vox_ch = u.channels | selectattr('tipo', 'equalto', 'VOX') | first %}
                {% set tir_ch = u.channels | selectattr('tipo', 'equalto', 'TIRADAS') | first %}

                <td class="channel-cell" id="ch-container-{{ vox_ch.id if vox_ch else 'none' }}" data-chid="{{ vox_ch.id if vox_ch else '' }}">
                    {% if vox_ch %}
                        <div class="channel-header">
                            <span class="badge {{ 'bg-online' if vox_ch.status == 'online' else 'bg-waiting' if vox_ch.status == 'waiting' else 'bg-offline' }}">{{ vox_ch.status|upper }}</span>
                            <span class="last-seen">{{ vox_ch.last_check.strftime('%H:%M') if vox_ch.last_check else '-' }}</span>
                        </div>
                        {% if vox_ch.token %}
                            <div class="token-row">
                                <div class="token-wrapper" style="border-left: 3px solid #17a2b8;">
                                    <input type="text" class="token-input" id="token-{{ vox_ch.id }}" value="{{ vox_ch.token }}" readonly onclick="this.select()">
                                    <button class="btn-copy-mini" onclick="copiarInput('token-{{ vox_ch.id }}')"><i class="fa-regular fa-copy"></i></button>
                                </div>
                                <form method="POST" onsubmit="return confirm('¬øDesconectar este canal?');">
                                    <input type="hidden" name="channel_id" value="{{ vox_ch.id }}">
                                    <input type="hidden" name="revoke_channel" value="1">
                                    <button type="submit" class="btn-mini-del"><i class="fa-solid fa-link-slash"></i></button>
                                </form>
                            </div>
                        {% elif vox_ch.code %}
                            <span class="pairing-code" style="color:#17a2b8;">{{ vox_ch.code }}</span>
                        {% else %}
                            <small style="color:#ccc;">No vinculado</small>
                            <form method="POST" style="display:inline; float:right;" onsubmit="return confirm('¬øBorrar canal?');">
                                <input type="hidden" name="channel_id" value="{{ vox_ch.id }}">
                                <input type="hidden" name="delete_channel" value="1">
                                <button type="submit" style="background:none; border:none; color:#ddd; cursor:pointer;"><i class="fa-solid fa-trash"></i></button>
                            </form>
                        {% endif %}
                    {% else %}
                        <small style="color:#eee;">-</small>
                    {% endif %}
                </td>

                <td class="channel-cell" id="ch-container-{{ tir_ch.id if tir_ch else 'none' }}" data-chid="{{ tir_ch.id if tir_ch else '' }}">
                    {% if tir_ch %}
                        <div class="channel-header">
                            <span class="badge {{ 'bg-online' if tir_ch.status == 'online' else 'bg-waiting' if tir_ch.status == 'waiting' else 'bg-offline' }}">{{ tir_ch.status|upper }}</span>
                            <span class="last-seen">{{ tir_ch.last_check.strftime('%H:%M') if tir_ch.last_check else '-' }}</span>
                        </div>
                        {% if tir_ch.token %}
                            <div class="token-row">
                                <div class="token-wrapper" style="border-left: 3px solid #e67e22;">
                                    <input type="text" class="token-input" id="token-{{ tir_ch.id }}" value="{{ tir_ch.token }}" readonly onclick="this.select()">
                                    <button class="btn-copy-mini" onclick="copiarInput('token-{{ tir_ch.id }}')"><i class="fa-regular fa-copy"></i></button>
                                </div>
                                <form method="POST" onsubmit="return confirm('¬øDesconectar este canal?');">
                                    <input type="hidden" name="channel_id" value="{{ tir_ch.id }}">
                                    <input type="hidden" name="revoke_channel" value="1">
                                    <button type="submit" class="btn-mini-del"><i class="fa-solid fa-link-slash"></i></button>
                                </form>
                            </div>
                        {% elif tir_ch.code %}
                            <span class="pairing-code" style="color:#e67e22;">{{ tir_ch.code }}</span>
                        {% else %}
                            <small style="color:#ccc;">No vinculado</small>
                            <form method="POST" style="display:inline; float:right;" onsubmit="return confirm('¬øBorrar canal?');">
                                <input type="hidden" name="channel_id" value="{{ tir_ch.id }}">
                                <input type="hidden" name="delete_channel" value="1">
                                <button type="submit" style="background:none; border:none; color:#ddd; cursor:pointer;"><i class="fa-solid fa-trash"></i></button>
                            </form>
                        {% endif %}
                    {% else %}
                        <small style="color:#eee;">-</small>
                    {% endif %}
                </td>

                <td style="text-align:center;">
                    <form action="{{ url_for('eliminar_estacion', id=u.id) }}" method="POST" onsubmit="return confirm('¬øELIMINAR ESTACI√ìN DEFINITIVAMENTE?');">
                        <button type="submit" class="btn-trash-station" title="Eliminar Estaci√≥n"><i class="fa-solid fa-trash"></i></button>
                    </form>
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function copiarInput(inputId) {
        var el = document.getElementById(inputId);
        if(!el) return;
        el.select();
        el.setSelectionRange(0, 99999);
        try { document.execCommand('copy'); el.style.backgroundColor = "#d4edda"; setTimeout(() => el.style.backgroundColor = "transparent", 300); } catch (err) {}
    }

    // --- ACTUALIZACI√ìN DIN√ÅMICA DE ESTADOS ---
    function updateStatus() {
        const ind = document.getElementById('loading-indicator');
        ind.style.opacity = '1';

        fetch('/admin/api/status-all')
            .then(r => r.json())
            .then(data => {
                setTimeout(() => ind.style.opacity = '0', 500);
                
                // Recorremos todos los usuarios
                data.forEach(u => {
                    // Recorremos sus canales
                    u.channels.forEach(ch => {
                        updateChannelUI(ch);
                    });
                });
            })
            .catch(() => ind.style.opacity = '0');
    }

    function updateChannelUI(ch) {
        // 1. Buscamos la celda usando el ID del canal (data-chid)
        const td = document.querySelector(`td[data-chid="${ch.id}"]`);
        if (!td) return; // Si el canal no est√° en la tabla (ej. es el segundo canal de vox y la tabla muestra solo el primero), lo ignoramos.

        // 2. Actualizar Badge y Hora
        const badge = td.querySelector('.badge');
        if (badge) {
            let cls = 'bg-offline';
            if(ch.status === 'online') cls = 'bg-online';
            if(ch.status === 'waiting') cls = 'bg-waiting';
            badge.className = `badge ${cls}`;
            badge.innerText = ch.status.toUpperCase();
        }
        
        const time = td.querySelector('.last-seen');
        if (time) time.innerText = ch.last_check;

        // 3. Actualizar Token si aparece de repente (Vinculaci√≥n exitosa)
        const tokenInput = document.getElementById(`token-${ch.id}`);
        
        // Si YA tenemos input y el token cambi√≥ (raro, pero posible)
        if (tokenInput && ch.token && tokenInput.value !== ch.token) {
            tokenInput.value = ch.token;
        }

        // Si NO tenemos input (estaba esperando) y ahora S√ç hay token -> Recargar para mostrar botones
        // (Detectamos esto si hay badge 'waiting' pero llega token)
        if (!tokenInput && ch.token) {
             // Opcional: location.reload() para que pinte el HTML completo del token;
             // Por simplicidad, solo recargamos si vemos un cambio dr√°stico de estado
             // window.location.reload(); 
        }
        
        // 4. Actualizar C√≥digo si cambi√≥
        const codeSpan = td.querySelector('.pairing-code');
        if (codeSpan && ch.code) codeSpan.innerText = ch.code;
    }

    setInterval(updateStatus, 3000);
</script>

</body>
</html>